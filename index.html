<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="theme-color" content="#000000" />
  <link rel="apple-touch-icon" href="/icon-192.png" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <link rel="manifest" href="/manifest.json" />
  <meta name="theme-color" content="#0a6bff" />
  <meta charset="UTF-8" />
  <title>Money Budgeter</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body>
  <div class="calculator-box">

    <!-- ‚úÖ PROFILE BADGE (TOP-LEFT) -->
    <div id="profile-badge" onclick="toggleProfileMenu()" aria-label="Profiles"></div>

    <div id="settings-icon" onclick="openSettings()">‚öôÔ∏è</div>

    <h1 id="title">Money Budgeter</h1>
    <div id="clock">üïí --:--</div>
    <div id="budget">Budget: $0.00</div>

    <input id="input-display" placeholder="0.00" readonly />

    <div class="numpad">
      <button onclick="appendNumber('1')">1</button>
      <button onclick="appendNumber('2')">2</button>
      <button onclick="appendNumber('3')">3</button>
      <button onclick="appendNumber('4')">4</button>
      <button onclick="appendNumber('5')">5</button>
      <button onclick="appendNumber('6')">6</button>
      <button onclick="appendNumber('7')">7</button>
      <button onclick="appendNumber('8')">8</button>
      <button onclick="appendNumber('9')">9</button>
      <button onclick="appendNumber('0')">0</button>

      <button id="decimalBtn" onclick="appendDecimal()">.</button>
      <button onclick="backspace()">‚å´</button>
    </div>

    <div class="buttons">
      <button id="addBtn" onclick="submitAmount('add')">Add</button>
      <button id="subtractBtn" onclick="openSubtract()">Subtract</button>
      <button id="clearBtn" onclick="clearHistory()">Clear History</button>
      <button id="resetBtn" onclick="resetBudget()">Reset</button>
      <button id="repeatBtn" onclick="location.href='repeat.html'">Repeat ‚ûï</button>
      <button id="viewCatBtn" onclick="viewCategoryTotals()">üìä View Categories</button>
    </div>

    <div class="history-header">
      <div id="historyLabel">History</div>
      <button id="toggleHistoryBtn" class="history-toggle">Expand ‚áµ</button>
    </div>
    <div id="history"></div>
  </div>

  <!-- Theme toggle -->
  <div id="mode-toggle" onclick="toggleMode()">üåô</div>

  <!-- Overlay (used for settings + profile menu + temp modals) -->
  <div id="overlay"></div>

  <!-- ‚úÖ PROFILE MENU (CLEAR + THEMED) -->
  <div id="profileMenu" class="profile-menu" role="dialog" aria-modal="true">
    <div class="profile-menu-head">
      <div class="profile-menu-title" id="profilesTitle">Profiles</div>
      <button class="close-btn" onclick="closeProfileMenu()">‚úñ</button>
    </div>

    <div id="profileList" class="profile-list"></div>

    <div class="profile-actions">
      <button class="btn" onclick="addProfile()">‚ûï Add</button>
      <button class="btn" onclick="editActiveProfile()">‚úèÔ∏è Edit</button>
      <button class="btn danger" onclick="deleteProfile()">üóë Delete</button>
    </div>
  </div>

  <!-- Settings modal -->
  <div id="settingsModal" class="modal" aria-modal="true" role="dialog">
    <h3 id="settingsTitle">Settings</h3>
    <hr />

    <h4 id="languageLabel">Language:</h4>
    <button class="btn" onclick="toggleLanguage()">
      <span id="langBtn">Switch to Arabic üá∏üá¶</span>
    </button>

    <h4 id="currencyLabel">Currency:</h4>
    <select id="currencySelect" class="mb-select">
      <option value="USD">USD ($)</option>
      <option value="QAR">QAR (ÿ±.ŸÇ)</option>
      <option value="EUR">EUR (‚Ç¨)</option>
      <option value="GBP">GBP (¬£)</option>
      <option value="SAR">SAR (ÿ±.ÿ≥)</option>
      <option value="AED">AED (ÿØ.ÿ•)</option>
      <option value="JOD">JOD (ÿØ.ÿß)</option>
      <option value="KWD">KWD (ÿØ.ŸÉ)</option>
    </select>

    <h4 id="featuresLabel">Features:</h4>

    <label>
      <span id="toggleCentsLbl">Smart cents input</span>
      <input type="checkbox" id="toggleCentsMode" />
    </label>

    <label><span id="toggleRepeatLbl">Show Repeat</span><input type="checkbox" id="toggleRepeat" /></label>
    <label><span id="toggleClearLbl">Show Clear History</span><input type="checkbox" id="toggleClear" /></label>
    <label><span id="toggleResetLbl">Show Reset</span><input type="checkbox" id="toggleReset" /></label>

    <h4 id="categoryLabel">Custom Categories:</h4>
    <div id="categoryList"></div>
    <input type="text" id="newCategoryInput" placeholder="Add new category" />
    <button class="btn" onclick="addCategory()">Add Category</button>
    <button class="btn" onclick="closeSettings()">Close</button>
  </div>

<script>
/* =========================
   ‚úÖ HAPTICS (MOBILE)
   ========================= */
function haptic(type='tap'){
  // Vibration API works on many Android browsers; iOS often ignores it (safe).
  if (!('vibrate' in navigator)) return;
  try{
    if (type === 'success') navigator.vibrate([12, 30, 12]);
    else if (type === 'error') navigator.vibrate([30, 20, 30]);
    else navigator.vibrate(10); // tap
  }catch(e){}
}

// ‚úÖ Haptic for ALL buttons automatically (every click/tap)
document.addEventListener('click', (e)=>{
  const btn = e.target.closest('button');
  if (btn && !btn.disabled) haptic('tap');
}, true);

/* ======= DOM ======= */
const modeBtn = document.getElementById('mode-toggle');
const overlay = document.getElementById('overlay');
const settingsModal = document.getElementById('settingsModal');
const historyEl = document.getElementById('history');
const repeatBtn = document.getElementById('repeatBtn');
const clearBtn  = document.getElementById('clearBtn');
const resetBtn  = document.getElementById('resetBtn');
const decimalBtn = document.getElementById('decimalBtn');
const inputEl = document.getElementById('input-display');

const profileBadge = document.getElementById('profile-badge');
const profileMenu  = document.getElementById('profileMenu');
const profileListEl = document.getElementById('profileList');

/* ======= Overlay click closes everything ======= */
overlay.addEventListener('click', ()=>{
  closeSettings();
  closeProfileMenu();
  closeTempModals();
});

/* ========= PROFILES SYSTEM =========
   Each profile: { id, name, emoji }
   Each profile data saved in: mb_profile_<id>
*/
const PROFILES_KEY = 'mb_profiles';
const ACTIVE_PROFILE_KEY = 'mb_activeProfileId';

function uid(){
  return 'p_' + Math.random().toString(36).slice(2) + Date.now().toString(36);
}
function loadProfiles(){
  return JSON.parse(localStorage.getItem(PROFILES_KEY)) || [];
}
function saveProfiles(list){
  localStorage.setItem(PROFILES_KEY, JSON.stringify(list));
}
function getActiveProfileId(){
  return localStorage.getItem(ACTIVE_PROFILE_KEY);
}
function setActiveProfileId(id){
  localStorage.setItem(ACTIVE_PROFILE_KEY, id);
}
function profileStoreKey(id){
  return `mb_profile_${id}`;
}

function defaultProfileData(){
  return {
    budget: 0,
    history: [],
    categories: ['Leisure','Transportation','Food','Groceries','Others','Games','Friends'],
    featureSettings: { repeat:true, clear:true, reset:true },
    centsMode: true,
    currency: 'USD',
    lang: (localStorage.getItem('lang') || 'en')
  };
}
function readProfileData(id){
  const raw = localStorage.getItem(profileStoreKey(id));
  if (!raw) return defaultProfileData();
  try{
    const parsed = JSON.parse(raw);
    return { ...defaultProfileData(), ...parsed };
  }catch(e){
    return defaultProfileData();
  }
}
function writeProfileData(id, data){
  localStorage.setItem(profileStoreKey(id), JSON.stringify(data));
}

/* ---- one-time migration from your old keys ---- */
function migrateOldDataIntoDefaultProfileIfNeeded(){
  const profiles = loadProfiles();
  if (profiles.length) return;

  const id = uid();
  saveProfiles([{ id, name:'Main', emoji:'üí∞' }]);
  setActiveProfileId(id);

  const oldBudget = parseFloat(localStorage.getItem('budget')) || 0;
  const oldHistory = JSON.parse(localStorage.getItem('history')) || [];
  const oldCategories = JSON.parse(localStorage.getItem('categories')) ||
    ['Leisure','Transportation','Food','Groceries','Others','Games','Friends'];
  const oldFeatureSettings = JSON.parse(localStorage.getItem('featureSettings')) ||
    { repeat:true, clear:true, reset:true };
  const oldCentsMode = (localStorage.getItem('centsMode') ?? 'true') === 'true';
  const oldCurrency = localStorage.getItem('currency') || 'USD';
  const oldLang = localStorage.getItem('lang') || 'en';

  writeProfileData(id, {
    budget: oldBudget,
    history: oldHistory,
    categories: oldCategories,
    featureSettings: oldFeatureSettings,
    centsMode: oldCentsMode,
    currency: oldCurrency,
    lang: oldLang
  });
}

/* ======= LIVE APP STATE ======= */
let categories = [];
let featureSettings = { repeat:true, clear:true, reset:true };
let lang = 'en';
let budget = 0;
let history = [];
let centsMode = true;

function persistCurrentProfile(){
  const id = getActiveProfileId();
  if (!id) return;
  writeProfileData(id, {
    budget,
    history,
    categories,
    featureSettings,
    centsMode,
    currency: getCurrency(),
    lang
  });
}
function loadActiveProfileIntoApp(){
  const id = getActiveProfileId();
  if (!id) return;

  const data = readProfileData(id);

  budget = Number(data.budget || 0);
  history = Array.isArray(data.history) ? data.history : [];
  categories = Array.isArray(data.categories) ? data.categories : defaultProfileData().categories;
  featureSettings = data.featureSettings || { repeat:true, clear:true, reset:true };
  centsMode = !!data.centsMode;

  localStorage.setItem('currency', data.currency || 'USD');

  lang = data.lang || (localStorage.getItem('lang') || 'en');
  localStorage.setItem('lang', lang);
}

/* ======= Profile UI ======= */
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m => ({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
  }[m]));
}
function getActiveProfileMeta(){
  const profiles = loadProfiles();
  const id = getActiveProfileId();
  return profiles.find(p=>p.id===id) || profiles[0];
}
function renderProfileBadge(){
  const p = getActiveProfileMeta();
  profileBadge.textContent = p?.emoji || 'üôÇ';
  profileBadge.title = p?.name || 'Profile';
}

function openProfileMenu(){
  renderProfileMenu();
  profileMenu.style.display = 'block';
  overlay.style.display = 'block';
  haptic('tap');
}
function closeProfileMenu(){
  profileMenu.style.display = 'none';
  if (settingsModal.style.display !== 'block' && document.querySelectorAll('.sleek-modal').length === 0){
    overlay.style.display = 'none';
  }
}
function toggleProfileMenu(){
  const open = profileMenu.style.display === 'block';
  if (open) closeProfileMenu();
  else openProfileMenu();
}

function renderProfileMenu(){
  renderProfileBadge();

  const profiles = loadProfiles();
  const active = getActiveProfileId();
  profileListEl.innerHTML = '';

  profiles.forEach(p=>{
    const row = document.createElement('button');
    row.type = 'button';
    row.className = 'profile-row' + (p.id===active ? ' active' : '');
    row.innerHTML = `
      <span class="profile-emoji">${p.emoji || 'üôÇ'}</span>
      <span class="profile-name">${escapeHtml(p.name || 'Profile')}</span>
      <span class="profile-check">‚úì</span>
    `;

    row.onclick = () => {
      // ‚úÖ only close (and animate) if switching to a different profile
      if (p.id === active) return;

      // ‚úÖ checkmark animation
      row.classList.add('switching');

      // ‚úÖ success haptic for switching
      haptic('success');

      // wait for animation then switch + close
      setTimeout(()=>{
        switchProfile(p.id);
        closeProfileMenu();
      }, 220);
    };

    profileListEl.appendChild(row);
  });
}

function switchProfile(id){
  const profiles = loadProfiles();
  if (!profiles.some(p=>p.id===id)) return;

  persistCurrentProfile();
  setActiveProfileId(id);

  loadActiveProfileIntoApp();

  clearInput();
  updateBudget();
  renderHistory();
  applyFeatureVisibility();
  syncDecimalButton();
  renderAmountInput();
  applyLanguage();

  renderProfileBadge();
  renderProfileMenu();
}

function addProfile(){
  const name = prompt(lang==='ar' ? 'ÿßÿ≥ŸÖ ÿßŸÑÿ®ÿ±ŸàŸÅÿßŸäŸÑÿü (ŸÖÿ´ŸÑ: ÿ™ÿ≥ŸàŸÇ)' : 'Profile name? (ex: Shopping)');
  if (!name) return;

  const emoji = prompt(lang==='ar' ? 'ÿ•ŸäŸÖŸàÿ¨Ÿä ŸÑŸÑÿ®ÿ±ŸàŸÅÿßŸäŸÑÿü (ŸÖÿ´ŸÑ üõçÔ∏è)' : 'Profile emoji? (ex üõçÔ∏è)', 'üõçÔ∏è');
  if (!emoji) return;

  persistCurrentProfile();

  const profiles = loadProfiles();
  const id = uid();
  profiles.push({ id, name: name.trim(), emoji: emoji.trim() });
  saveProfiles(profiles);

  writeProfileData(id, defaultProfileData());

  // switch immediately
  switchProfile(id);
  // keep menu open after add (feels better), but you can close if you want:
  // closeProfileMenu();
  haptic('success');
}

function editActiveProfile(){
  const profiles = loadProfiles();
  const active = getActiveProfileId();
  const p = profiles.find(x=>x.id===active);
  if (!p) return;

  const newName = prompt(lang==='ar' ? 'ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑÿ¨ÿØŸäÿØ:' : 'New name:', p.name || '');
  if (!newName) return;

  const newEmoji = prompt(lang==='ar' ? 'ÿßŸÑÿ•ŸäŸÖŸàÿ¨Ÿä ÿßŸÑÿ¨ÿØŸäÿØ:' : 'New emoji:', p.emoji || 'üôÇ');
  if (!newEmoji) return;

  p.name = newName.trim();
  p.emoji = newEmoji.trim();
  saveProfiles(profiles);

  renderProfileBadge();
  renderProfileMenu();
  haptic('success');
}

function deleteProfile(){
  const profiles = loadProfiles();
  const active = getActiveProfileId();

  if (profiles.length <= 1){
    alert(lang==='ar' ? 'ŸÑÿß ŸäŸÖŸÉŸÜ ÿ≠ÿ∞ŸÅ ÿ¢ÿÆÿ± ÿ®ÿ±ŸàŸÅÿßŸäŸÑ.' : "You can't delete the last profile.");
    haptic('error');
    return;
  }

  const p = profiles.find(x=>x.id===active);
  const ok = confirm(
    (lang==='ar'
      ? `ÿ≠ÿ∞ŸÅ ÿßŸÑÿ®ÿ±ŸàŸÅÿßŸäŸÑ "${p?.name || ''}"ÿü`
      : `Delete profile "${p?.name || ''}"?`) +
    (lang==='ar' ? '\nÿ≥Ÿäÿ™ŸÖ ÿ≠ÿ∞ŸÅ ÿßŸÑŸÖŸäÿ≤ÿßŸÜŸäÿ© ŸàÿßŸÑÿ≥ÿ¨ŸÑ.' : '\nThis removes its budget and history.')
  );
  if (!ok) return;

  persistCurrentProfile();

  localStorage.removeItem(profileStoreKey(active));
  const next = profiles.filter(x=>x.id!==active);
  saveProfiles(next);

  setActiveProfileId(next[0].id);
  loadActiveProfileIntoApp();

  clearInput();
  updateBudget();
  renderHistory();
  applyFeatureVisibility();
  syncDecimalButton();
  renderAmountInput();
  applyLanguage();

  renderProfileBadge();
  renderProfileMenu();
  haptic('success');
}

/* ======= Currency helpers ======= */
function getCurrency(){
  return localStorage.getItem('currency') || 'USD';
}
function formatMoney(value){
  const currency = getCurrency();
  try{
    return new Intl.NumberFormat(undefined, { style:'currency', currency }).format(value);
  } catch(e){
    return `$${Number(value || 0).toFixed(2)}`;
  }
}

/* ======= Clock ======= */
function tickClock(){
  const n = new Date();
  document.getElementById('clock').textContent =
    'üïí ' + n.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
}
setInterval(tickClock,1000); tickClock();

/* ======= Input state ======= */
let amountDigits = '';
let amountRaw = '';

function moneyFromDigits(d){
  if (!d) return 0;
  const cents = parseInt(d, 10);
  if (isNaN(cents)) return 0;
  return cents / 100;
}
function moneyFromRaw(s){
  if (!s) return 0;
  const v = parseFloat(s);
  if (isNaN(v)) return 0;
  return v;
}
function renderAmountInput(){
  const v = centsMode ? moneyFromDigits(amountDigits) : moneyFromRaw(amountRaw);
  inputEl.value = formatMoney(v);
}
function syncDecimalButton(){
  decimalBtn.style.display = centsMode ? 'none' : '';
}
function clearInput(){
  amountDigits = '';
  amountRaw = '';
  renderAmountInput();
}
function appendNumber(n){
  if (!/^\d$/.test(n)) return;

  if (centsMode){
    if (amountDigits.length >= 12) return;
    if (amountDigits === '0') amountDigits = '';
    amountDigits += n;
  } else {
    if (amountRaw.length >= 14) return;
    if (amountRaw.includes('.')){
      const parts = amountRaw.split('.');
      const dec = parts[1] ?? '';
      if (dec.length >= 2) return;
    }
    amountRaw += n;
  }
  renderAmountInput();
}
function appendDecimal(){
  if (centsMode) return;
  if (!amountRaw) amountRaw = '0';
  if (amountRaw.includes('.')) return;
  amountRaw += '.';
  renderAmountInput();
}
function backspace(){
  if (centsMode) amountDigits = amountDigits.slice(0, -1);
  else amountRaw = amountRaw.slice(0, -1);
  renderAmountInput();
}

/* ======= Add/Subtract ======= */
function getCurrentAmount(){
  return centsMode ? moneyFromDigits(amountDigits) : moneyFromRaw(amountRaw);
}
function submitAmount(type){
  const v = getCurrentAmount();
  if (!v) return;

  const ts = new Date().toLocaleString();

  if (type==='add'){
    budget += v;
    history.push({type:'Add', value:v, timestamp:ts});
  }

  saveBudget();
  renderHistory();
  clearInput();
}

/* ======= Temp modals helpers ======= */
function closeTempModals(){
  document.querySelectorAll('.sleek-modal').forEach(el=>el.remove());
  if (settingsModal.style.display !== 'block' && profileMenu.style.display !== 'block'){
    overlay.style.display = 'none';
  }
}
function showModal(el){
  el.style.display='block';
  overlay.style.display='block';
}

/* ======= Subtract ======= */
function openSubtract(){
  const m = document.createElement('div');
  m.className = 'modal sleek-modal';
  m.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center;width:100%;">
      <h3>${lang==='ar'?'ÿßÿÆÿ™ÿ± ÿßŸÑŸÅÿ¶ÿ©':'Select Category'}</h3>
      <button class="close-btn" onclick="closeTempModals()">‚úñ</button>
    </div>
    <div style="display:flex;flex-direction:column;align-items:center;width:100%;margin-top:8px;">
      ${categories.map(c =>
        `<button class="btn" style="width:90%;margin:6px 0;" onclick="doSubtract('${c.replace(/'/g,"&#39;")}')">${escapeHtml(c)}</button>`
      ).join('')}
    </div>`;
  document.body.appendChild(m);
  showModal(m);
}
function doSubtract(cat){
  const v = getCurrentAmount();
  if (!v) { closeTempModals(); return; }

  const ts = new Date().toLocaleString();
  budget -= v;
  history.push({type:`Subtract (${cat})`, value:v, timestamp:ts});

  saveBudget();
  renderHistory();
  clearInput();
  closeTempModals();
}

/* ======= History ======= */
function renderHistory(){
  historyEl.innerHTML = '';
  history.slice().reverse().forEach(it=>{
    const d=document.createElement('div');
    d.textContent = `${it.timestamp} ‚Äî ${it.type}: ${formatMoney(it.value)}`;
    historyEl.appendChild(d);
  });
}
function clearHistory(){
  history = [];
  saveBudget();
  renderHistory();
}
function resetBudget(){
  budget = 0;
  saveBudget();
}
function saveBudget(){
  updateBudget();
  persistCurrentProfile();
}
function updateBudget(){
  document.getElementById('budget').textContent = `Budget: ${formatMoney(budget)}`;
}

/* ======= Theme ======= */
function toggleMode(){
  haptic('tap');
  const dark = document.body.classList.contains('dark-mode');
  document.body.classList.toggle('dark-mode', !dark);
  document.body.classList.toggle('light-mode', dark);
  localStorage.setItem('theme', dark ? 'light' : 'dark');
  modeBtn.textContent = dark ? 'üåô' : '‚òÄÔ∏è';
}
(function initTheme(){
  if (localStorage.getItem('theme')==='dark'){
    document.body.classList.add('dark-mode'); modeBtn.textContent='‚òÄÔ∏è';
  } else {
    document.body.classList.add('light-mode');
  }
})();

/* ======= Settings ======= */
function openSettings(){
  haptic('tap');
  renderSettings();
  settingsModal.style.display='block';
  overlay.style.display='block';
}
function closeSettings(){
  settingsModal.style.display='none';
  if (profileMenu.style.display !== 'block' && document.querySelectorAll('.sleek-modal').length === 0){
    overlay.style.display='none';
  }
  persistCurrentProfile();
}
function renderSettings(){
  const tRepeat = document.getElementById('toggleRepeat');
  const tClear  = document.getElementById('toggleClear');
  const tReset  = document.getElementById('toggleReset');

  tRepeat.checked = !!featureSettings.repeat;
  tClear.checked  = !!featureSettings.clear;
  tReset.checked  = !!featureSettings.reset;

  applyFeatureVisibility();

  tRepeat.onchange = ()=>{ featureSettings.repeat=tRepeat.checked; persistCurrentProfile(); applyFeatureVisibility(); };
  tClear.onchange  = ()=>{ featureSettings.clear=tClear.checked;   persistCurrentProfile(); applyFeatureVisibility(); };
  tReset.onchange  = ()=>{ featureSettings.reset=tReset.checked;   persistCurrentProfile(); applyFeatureVisibility(); };

  const curSel = document.getElementById('currencySelect');
  if (curSel){
    curSel.value = getCurrency();
    curSel.onchange = ()=>{
      localStorage.setItem('currency', curSel.value);
      persistCurrentProfile();
      updateBudget();
      renderHistory();
      renderAmountInput();
    };
  }

  const centsToggle = document.getElementById('toggleCentsMode');
  if (centsToggle){
    centsToggle.checked = centsMode;
    centsToggle.onchange = ()=>{
      centsMode = centsToggle.checked;
      clearInput();
      syncDecimalButton();
      persistCurrentProfile();
    };
  }

  const list=document.getElementById('categoryList');
  list.innerHTML='';
  categories.forEach((c,i)=>{
    const row=document.createElement('div');
    row.innerHTML = `${escapeHtml(c)}
      <button style="float:right;background:#ef4444;color:#fff;border:none;border-radius:8px;padding:2px 8px;font-weight:800"
        onclick="removeCategory(${i})">X</button>`;
    list.appendChild(row);
  });
}
function applyFeatureVisibility(){
  repeatBtn.style.display = featureSettings.repeat ? '' : 'none';
  clearBtn.style.display  = featureSettings.clear  ? '' : 'none';
  resetBtn.style.display  = featureSettings.reset  ? '' : 'none';
}
function addCategory(){
  const inp=document.getElementById('newCategoryInput');
  const val=(inp.value||'').trim();
  if(!val || categories.includes(val)) return;
  categories.push(val);
  inp.value='';
  persistCurrentProfile();
  renderSettings();
}
function removeCategory(i){
  categories.splice(i,1);
  persistCurrentProfile();
  renderSettings();
}

/* ======= Language ======= */
function toggleLanguage(){
  lang = (lang==='en') ? 'ar' : 'en';
  localStorage.setItem('lang', lang);
  persistCurrentProfile();
  applyLanguage();
  renderProfileMenu();
}
function applyLanguage(){
  const en={
    title:'Money Budgeter', settingsTitle:'Settings', languageLabel:'Language:',
    featuresLabel:'Features:', categoryLabel:'Custom Categories:',
    toggleRepeatLbl:'Show Repeat', toggleClearLbl:'Show Clear History',
    toggleResetLbl:'Show Reset', langBtn:'Switch to Arabic üá∏üá¶',
    historyLabel:'History', currencyLabel:'Currency:', toggleCentsLbl:'Smart cents input',
    profilesTitle:'Profiles'
  };
  const ar={
    title:'ŸÖÿØŸäÿ± ÿßŸÑŸÖŸäÿ≤ÿßŸÜŸäÿ©', settingsTitle:'ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™', languageLabel:'ÿßŸÑŸÑÿ∫ÿ©:',
    featuresLabel:'ÿßŸÑÿÆÿµÿßÿ¶ÿµ:', categoryLabel:'ÿßŸÑŸÅÿ¶ÿßÿ™ ÿßŸÑŸÖÿÆÿµÿµÿ©:',
    toggleRepeatLbl:'ÿπÿ±ÿ∂ ÿßŸÑÿ™ŸÉÿ±ÿßÿ±', toggleClearLbl:'ÿπÿ±ÿ∂ ŸÖÿ≥ÿ≠ ÿßŸÑÿ≥ÿ¨ŸÑ',
    toggleResetLbl:'ÿπÿ±ÿ∂ ÿ•ÿπÿßÿØÿ© ÿßŸÑÿ∂ÿ®ÿ∑', langBtn:'ÿßŸÑÿ™ÿ®ÿØŸäŸÑ ÿ•ŸÑŸâ ÿßŸÑÿ•ŸÜÿ¨ŸÑŸäÿ≤Ÿäÿ© üá¨üáß',
    historyLabel:'ÿßŸÑÿ≥ÿ¨ŸÑ', currencyLabel:'ÿßŸÑÿπŸÖŸÑÿ©:', toggleCentsLbl:'ÿ•ÿØÿÆÿßŸÑ ÿ∞ŸÉŸä (ÿ≥ŸÜÿ™ÿßÿ™)',
    profilesTitle:'ÿßŸÑÿ®ÿ±ŸàŸÅÿßŸäŸÑÿßÿ™'
  };
  const t=(lang==='ar')?ar:en;

  document.getElementById('title').textContent=t.title;
  document.getElementById('settingsTitle').textContent=t.settingsTitle;
  document.getElementById('languageLabel').textContent=t.languageLabel;
  document.getElementById('featuresLabel').textContent=t.featuresLabel;
  document.getElementById('categoryLabel').textContent=t.categoryLabel;
  document.getElementById('toggleRepeatLbl').textContent=t.toggleRepeatLbl;
  document.getElementById('toggleClearLbl').textContent=t.toggleClearLbl;
  document.getElementById('toggleResetLbl').textContent=t.toggleResetLbl;
  document.getElementById('langBtn').textContent=t.langBtn;
  document.getElementById('historyLabel').textContent=t.historyLabel;
  document.getElementById('currencyLabel').textContent=t.currencyLabel;
  document.getElementById('toggleCentsLbl').textContent=t.toggleCentsLbl;
  document.getElementById('profilesTitle').textContent = t.profilesTitle;

  document.body.setAttribute('dir', (lang==='ar')?'rtl':'ltr');
}
applyLanguage();

/* ======= Category totals ======= */
function viewCategoryTotals(){
  const totals = Object.fromEntries(categories.map(c=>[c,0]));
  history.forEach(h=>{
    const m = h.type.match(/^Subtract \((.+)\)$/);
    if (m && totals[m[1]]!==undefined) totals[m[1]] += h.value;
  });
  const title = (lang==='ar'?'ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÅÿ¶ÿßÿ™':'Category Totals');

  const m = document.createElement('div');
  m.className = 'modal sleek-modal';
  m.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center;width:100%;">
      <h3>${title}</h3>
      <button class="close-btn" onclick="closeTempModals()">‚úñ</button>
    </div>
    <div style="display:flex;flex-direction:column;align-items:center;width:100%;margin-top:8px;">
      ${categories.map(c =>
        `<button class="btn" style="width:90%;margin:6px 0;" disabled>${escapeHtml(c)}: ${formatMoney(totals[c])}</button>`
      ).join('')}
    </div>`;
  document.body.appendChild(m);
  showModal(m);
}

/* ======= Fullscreen history ======= */
function openFullHistory(){
  const holder = document.createElement('div');
  holder.className = 'sleek-modal';

  const panel = document.createElement('div');
  panel.innerHTML =
    `<h3 style="text-align:center;margin-bottom:10px;">${lang==='ar'?'ÿßŸÑÿ≥ÿ¨ŸÑ ÿßŸÑŸÉÿßŸÖŸÑ':'Full History'}</h3>` +
    history.slice().reverse().map(it =>
      `<div style="padding:8px 6px;border-bottom:1px solid rgba(255,255,255,.08);">
        ${escapeHtml(it.timestamp)} ‚Äî ${escapeHtml(it.type)}: ${formatMoney(it.value)}
      </div>`
    ).join('') +
    `<button class="btn" style="margin-top:10px;width:100%;" onclick="closeTempModals()">${lang==='ar'?'ÿ•ÿ∫ŸÑÿßŸÇ':'Close'}</button>`;

  holder.appendChild(panel);
  document.body.appendChild(holder);
  overlay.style.display='block';
}
document.getElementById('toggleHistoryBtn').addEventListener('click', openFullHistory);

/* ======= Init ======= */
function init(){
  migrateOldDataIntoDefaultProfileIfNeeded();

  const profiles = loadProfiles();
  if (!getActiveProfileId() && profiles.length){
    setActiveProfileId(profiles[0].id);
  }
  if (!getActiveProfileId()){
    const id = uid();
    saveProfiles([{ id, name:'Main', emoji:'üí∞' }]);
    setActiveProfileId(id);
    writeProfileData(id, defaultProfileData());
  }

  loadActiveProfileIntoApp();

  updateBudget();
  renderHistory();
  applyFeatureVisibility();
  syncDecimalButton();
  renderAmountInput();
  renderProfileBadge();

  modeBtn.textContent = document.body.classList.contains('dark-mode') ? '‚òÄÔ∏è' : 'üåô';
}
init();
</script>

<script src="/pwa-bridge.js"></script>

<script>
// Disable pinch-zoom, double-tap zoom, and ctrl+wheel zoom
(function(){
  document.addEventListener('gesturestart', function (e) { e.preventDefault(); }, { passive: false });
  let lastTouch = 0;
  document.addEventListener('touchend', function (e) {
    const now = Date.now();
    if (now - lastTouch <= 300) { e.preventDefault(); }
    lastTouch = now;
  }, { passive: false });
  document.addEventListener('wheel', function (e) {
    if (e.ctrlKey) e.preventDefault();
  }, { passive: false });
})();
</script>

</body>
</html>
