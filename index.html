<!-- =========================
PART 1 / 4  (HTML STRUCTURE)
Ask for â€œpart 2â€ when ready.
========================= -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="theme-color" content="#000000" />
  <link rel="apple-touch-icon" href="/icon-192.png" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <link rel="manifest" href="/manifest.json" />
  <meta name="theme-color" content="#0a6bff" />
  <meta charset="UTF-8" />
  <title>Money Budgeter</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body>
  <div class="calculator-box">

    <!-- âœ… Profile badge (top-left) -->
    <div id="profile-badge" onclick="toggleProfileMenu()" aria-label="Profiles"></div>

    <!-- Settings (top-right) -->
    <div id="settings-icon" onclick="openSettings()">âš™ï¸</div>

    <h1 id="title">Money Budgeter</h1>
    <div id="clock">ğŸ•’ --:--</div>
    <div id="budget">Budget: $0.00</div>

    <input id="input-display" placeholder="0.00" readonly />

    <!-- âœ… Adjustable quick amounts bar -->
    <div id="quickBar" class="quick-bar"></div>

    <div class="numpad">
      <button onclick="appendNumber('1')">1</button>
      <button onclick="appendNumber('2')">2</button>
      <button onclick="appendNumber('3')">3</button>
      <button onclick="appendNumber('4')">4</button>
      <button onclick="appendNumber('5')">5</button>
      <button onclick="appendNumber('6')">6</button>
      <button onclick="appendNumber('7')">7</button>
      <button onclick="appendNumber('8')">8</button>
      <button onclick="appendNumber('9')">9</button>
      <button id="zeroBtn" onclick="appendNumber('0')">0</button>

      <!-- Decimal button visible ONLY when Smart cents input is OFF -->
      <button id="decimalBtn" onclick="appendDecimal()">.</button>

      <button id="backspaceBtn" onclick="backspace()">âŒ«</button>
    </div>

    <div class="buttons">
      <button id="addBtn" onclick="submitAmount('add')">Add</button>
      <button id="subtractBtn" onclick="openSubtract()">Subtract</button>
      <button id="clearBtn" onclick="clearHistory()">Clear History</button>
      <button id="resetBtn" onclick="resetBudget()">Reset</button>
      <button id="repeatBtn" onclick="location.href='repeat.html'">Repeat â•</button>
      <button id="viewCatBtn" onclick="viewCategoryTotals()">ğŸ“Š View Categories</button>
      <button id="chartsBtn" onclick="openCharts()">ğŸ“ˆ Charts</button>
      <button id="filterBtn" onclick="openFilters()">ğŸ” Filter</button>
    </div>

    <div class="history-header">
      <div id="historyLabel">History</div>
      <button id="toggleHistoryBtn" class="history-toggle">Expand â‡µ</button>
    </div>

    <div id="history"></div>
  </div>

  <!-- Theme toggle -->
  <div id="mode-toggle" onclick="toggleMode()">ğŸŒ™</div>

  <!-- Overlay (used for settings + profile menu + temp modals) -->
  <div id="overlay"></div>

  <!-- âœ… Profile menu (top-left) -->
  <div id="profileMenu" class="profile-menu" role="dialog" aria-modal="true">
    <div class="profile-menu-head">
      <div class="profile-menu-title" id="profilesTitle">Profiles</div>
      <button class="close-btn" onclick="closeProfileMenu()">âœ–</button>
    </div>

    <div id="profileList" class="profile-list"></div>

    <!-- âœ… only Add button here (Edit/Delete are per-row, on the side) -->
    <div class="profile-actions">
      <button class="btn" onclick="addProfile()">â• Add</button>
    </div>
  </div>

  <!-- âœ… Settings modal -->
  <div id="settingsModal" class="modal" aria-modal="true" role="dialog">
    <h3 id="settingsTitle">Settings</h3>
    <hr />

    <h4 id="languageLabel">Language:</h4>
    <button class="btn" onclick="toggleLanguage()">
      <span id="langBtn">Switch to Arabic ğŸ‡¸ğŸ‡¦</span>
    </button>

    <h4 id="currencyLabel">Currency:</h4>
    <select id="currencySelect" class="mb-select">
      <option value="USD">USD ($)</option>
      <option value="QAR">QAR (Ø±.Ù‚)</option>
      <option value="EUR">EUR (â‚¬)</option>
      <option value="GBP">GBP (Â£)</option>
      <option value="SAR">SAR (Ø±.Ø³)</option>
      <option value="AED">AED (Ø¯.Ø¥)</option>
      <option value="JOD">JOD (Ø¯.Ø§)</option>
      <option value="KWD">KWD (Ø¯.Ùƒ)</option>
    </select>

    <h4 id="featuresLabel">Features:</h4>

    <label>
      <span id="toggleCentsLbl">Smart cents input</span>
      <input type="checkbox" id="toggleCentsMode" />
    </label>

    <label><span id="toggleRepeatLbl">Show Repeat</span><input type="checkbox" id="toggleRepeat" /></label>
    <label><span id="toggleClearLbl">Show Clear History</span><input type="checkbox" id="toggleClear" /></label>
    <label><span id="toggleResetLbl">Show Reset</span><input type="checkbox" id="toggleReset" /></label>

    <!-- âœ… Quick amounts editor (adjustable per profile) -->
    <h4 id="quickLabel">Quick Amounts:</h4>
    <div id="quickEditor" class="quick-editor"></div>
    <input id="quickNew" type="number" inputmode="numeric" placeholder="Add amount (ex: 7)" />
    <button class="btn" onclick="addQuickAmount()">Add Quick Amount</button>

    <!-- âœ… PIN (4-digit) -->
    <h4 id="pinLabel">PIN Lock:</h4>
    <button class="btn" onclick="openPinSettings()">ğŸ”’ PIN Settings</button>

    <h4 id="categoryLabel">Custom Categories:</h4>
    <div id="categoryList"></div>
    <input type="text" id="newCategoryInput" placeholder="Add new category" />
    <button class="btn" onclick="addCategory()">Add Category</button>

    <button class="btn" onclick="closeSettings()">Close</button>
  </div>

  <!-- âœ… Scripts start in PART 2 -->
  <script>
    <!-- =========================
PART 2 / 4  (JS: CORE + PROFILES + HAPTICS + INPUT + QUICK AMOUNTS)
Ask for â€œpart 3â€ when ready.
========================= -->
/* =========================
   âœ… HAPTICS (MOBILE)
   ========================= */
function haptic(type='tap'){
  if (!('vibrate' in navigator)) return;
  try{
    if (type === 'success') navigator.vibrate([12, 30, 12]);
    else if (type === 'error') navigator.vibrate([30, 20, 30]);
    else navigator.vibrate(10);
  }catch(e){}
}

/* âœ… Haptic for ALL buttons */
document.addEventListener('click', (e)=>{
  const btn = e.target.closest('button');
  if (btn && !btn.disabled) haptic('tap');
}, true);

/* ======= DOM ======= */
const modeBtn = document.getElementById('mode-toggle');
const overlay = document.getElementById('overlay');
const settingsModal = document.getElementById('settingsModal');
const historyEl = document.getElementById('history');
const repeatBtn = document.getElementById('repeatBtn');
const clearBtn  = document.getElementById('clearBtn');
const resetBtn  = document.getElementById('resetBtn');
const decimalBtn = document.getElementById('decimalBtn');
const inputEl = document.getElementById('input-display');

const profileBadge = document.getElementById('profile-badge');
const profileMenu  = document.getElementById('profileMenu');
const profileListEl = document.getElementById('profileList');

const backspaceBtn = document.getElementById('backspaceBtn');
const zeroBtn = document.getElementById('zeroBtn');

/* ======= Overlay click closes everything ======= */
overlay.addEventListener('click', ()=>{
  closeSettings();
  closeProfileMenu();
  closeTempModals();
  closeFilters();
  closeCharts();
  closePinModals();
});

/* ========= PROFILES ========= */
const PROFILES_KEY = 'mb_profiles';
const ACTIVE_PROFILE_KEY = 'mb_activeProfileId';

function uid(){
  return 'p_' + Math.random().toString(36).slice(2) + Date.now().toString(36);
}
function loadProfiles(){
  return JSON.parse(localStorage.getItem(PROFILES_KEY)) || [];
}
function saveProfiles(list){
  localStorage.setItem(PROFILES_KEY, JSON.stringify(list));
}
function getActiveProfileId(){
  return localStorage.getItem(ACTIVE_PROFILE_KEY);
}
function setActiveProfileId(id){
  localStorage.setItem(ACTIVE_PROFILE_KEY, id);
}
function profileStoreKey(id){
  return `mb_profile_${id}`;
}

/* ======= Default profile data ======= */
function defaultProfileData(){
  return {
    budget: 0,
    history: [],
    categories: ['Leisure','Transportation','Food','Groceries','Others','Games','Friends'],
    featureSettings: { repeat:true, clear:true, reset:true },
    centsMode: true,
    currency: 'USD',
    lang: (localStorage.getItem('lang') || 'en'),
    quickAmounts: [-1,-3,-5,-10,-20],   // âœ… adjustable
    pinEnabled: false,
    pinHash: ''
  };
}

function readProfileData(id){
  const raw = localStorage.getItem(profileStoreKey(id));
  if (!raw) return defaultProfileData();
  try{
    const parsed = JSON.parse(raw);
    return { ...defaultProfileData(), ...parsed };
  }catch(e){
    return defaultProfileData();
  }
}
function writeProfileData(id, data){
  localStorage.setItem(profileStoreKey(id), JSON.stringify(data));
}

/* ---- one-time migration from your old single-profile keys ---- */
function migrateOldDataIntoDefaultProfileIfNeeded(){
  const profiles = loadProfiles();
  if (profiles.length) return;

  const id = uid();
  saveProfiles([{ id, name:'Main', emoji:'ğŸ’°' }]);
  setActiveProfileId(id);

  const oldBudget = parseFloat(localStorage.getItem('budget')) || 0;
  const oldHistory = JSON.parse(localStorage.getItem('history')) || [];
  const oldCategories = JSON.parse(localStorage.getItem('categories')) ||
    ['Leisure','Transportation','Food','Groceries','Others','Games','Friends'];
  const oldFeatureSettings = JSON.parse(localStorage.getItem('featureSettings')) ||
    { repeat:true, clear:true, reset:true };
  const oldCentsMode = (localStorage.getItem('centsMode') ?? 'true') === 'true';
  const oldCurrency = localStorage.getItem('currency') || 'USD';
  const oldLang = localStorage.getItem('lang') || 'en';

  writeProfileData(id, {
    ...defaultProfileData(),
    budget: oldBudget,
    history: oldHistory,
    categories: oldCategories,
    featureSettings: oldFeatureSettings,
    centsMode: oldCentsMode,
    currency: oldCurrency,
    lang: oldLang
  });
}

/* ======= LIVE APP STATE (active profile) ======= */
let categories = [];
let featureSettings = { repeat:true, clear:true, reset:true };
let lang = 'en';
let budget = 0;
let history = [];
let centsMode = true;
let quickAmounts = [-1,-3,-5,-10,-20];

/* PIN state (per profile) */
let pinEnabled = false;
let pinHash = '';

function persistCurrentProfile(){
  const id = getActiveProfileId();
  if (!id) return;
  writeProfileData(id, {
    budget,
    history,
    categories,
    featureSettings,
    centsMode,
    currency: getCurrency(),
    lang,
    quickAmounts,
    pinEnabled,
    pinHash
  });
}
function loadActiveProfileIntoApp(){
  const id = getActiveProfileId();
  if (!id) return;

  const data = readProfileData(id);

  budget = Number(data.budget || 0);
  history = Array.isArray(data.history) ? data.history : [];
  categories = Array.isArray(data.categories) ? data.categories : defaultProfileData().categories;
  featureSettings = data.featureSettings || { repeat:true, clear:true, reset:true };
  centsMode = !!data.centsMode;

  quickAmounts = Array.isArray(data.quickAmounts) ? data.quickAmounts : [-1,-3,-5,-10,-20];

  pinEnabled = !!data.pinEnabled;
  pinHash = String(data.pinHash || '');

  localStorage.setItem('currency', data.currency || 'USD');

  lang = data.lang || (localStorage.getItem('lang') || 'en');
  localStorage.setItem('lang', lang);
}

/* ======= Profile UI helpers ======= */
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m => ({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
  }[m]));
}
function getActiveProfileMeta(){
  const profiles = loadProfiles();
  const id = getActiveProfileId();
  return profiles.find(p=>p.id===id) || profiles[0];
}
function renderProfileBadge(){
  const p = getActiveProfileMeta();
  profileBadge.textContent = p?.emoji || 'ğŸ™‚';
  profileBadge.title = p?.name || 'Profile';
}

/* ======= Profile menu open/close ======= */
function openProfileMenu(){
  renderProfileMenu();
  profileMenu.style.display = 'block';
  overlay.style.display = 'block';
}
function closeProfileMenu(){
  profileMenu.style.display = 'none';
  if (settingsModal.style.display !== 'block' &&
      document.querySelectorAll('.sleek-modal').length === 0){
    overlay.style.display = 'none';
  }
}
function toggleProfileMenu(){
  const open = profileMenu.style.display === 'block';
  if (open) closeProfileMenu();
  else openProfileMenu();
}

/* âœ… Edit/Delete on the side of each profile row + auto-close only if switching */
function renderProfileMenu(){
  renderProfileBadge();

  const profiles = loadProfiles();
  const active = getActiveProfileId();
  profileListEl.innerHTML = '';

  profiles.forEach(p=>{
    const row = document.createElement('div');
    row.className = 'profile-row-wrap' + (p.id===active ? ' active' : '');

    row.innerHTML = `
      <button class="profile-row" type="button">
        <span class="profile-emoji">${escapeHtml(p.emoji || 'ğŸ™‚')}</span>
        <span class="profile-name">${escapeHtml(p.name || 'Profile')}</span>
        <span class="profile-check">âœ“</span>
      </button>

      <div class="profile-row-actions">
        <button class="mini-icon" title="Edit" aria-label="Edit" onclick="event.stopPropagation(); editProfile('${p.id}')">âœï¸</button>
        <button class="mini-icon danger" title="Delete" aria-label="Delete" onclick="event.stopPropagation(); deleteProfileById('${p.id}')">ğŸ—‘</button>
      </div>
    `;

    // clicking the main row switches
    row.querySelector('.profile-row').onclick = () => {
      if (p.id === active) return; // âœ… donâ€™t close if same

      // check animation
      row.querySelector('.profile-row').classList.add('switching');
      haptic('success');

      setTimeout(()=>{
        switchProfile(p.id);
        closeProfileMenu();
      }, 220);
    };

    // disable delete icon if last profile
    if (profiles.length <= 1){
      const delBtn = row.querySelector('.mini-icon.danger');
      delBtn.disabled = true;
      delBtn.style.opacity = '0.35';
      delBtn.style.cursor = 'not-allowed';
    }

    profileListEl.appendChild(row);
  });
}

function switchProfile(id){
  const profiles = loadProfiles();
  if (!profiles.some(p=>p.id===id)) return;

  persistCurrentProfile();
  setActiveProfileId(id);

  loadActiveProfileIntoApp();

  clearInput();
  updateBudget();
  renderHistory();
  applyFeatureVisibility();
  syncDecimalButton();
  renderAmountInput();
  applyLanguage();
  renderQuickBar();
  renderQuickEditor();
  renderProfileBadge();
  renderProfileMenu();
}

function addProfile(){
  const name = prompt(lang==='ar' ? 'Ø§Ø³Ù… Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ØŸ' : 'Profile name? (ex: Shopping)');
  if (!name) return;

  const emoji = prompt(lang==='ar' ? 'Ø¥ÙŠÙ…ÙˆØ¬ÙŠ Ù„Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ØŸ' : 'Profile emoji? (ex ğŸ›ï¸)', 'ğŸ›ï¸');
  if (!emoji) return;

  persistCurrentProfile();

  const profiles = loadProfiles();
  const id = uid();
  profiles.push({ id, name: name.trim(), emoji: emoji.trim() });
  saveProfiles(profiles);

  writeProfileData(id, defaultProfileData());

  switchProfile(id);
  haptic('success');
}

function editProfile(id){
  const profiles = loadProfiles();
  const p = profiles.find(x=>x.id===id);
  if (!p) return;

  const newName = prompt(lang==='ar' ? 'Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯:' : 'New name:', p.name || '');
  if (!newName) return;

  const newEmoji = prompt(lang==='ar' ? 'Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯:' : 'New emoji:', p.emoji || 'ğŸ™‚');
  if (!newEmoji) return;

  p.name = newName.trim();
  p.emoji = newEmoji.trim();
  saveProfiles(profiles);

  renderProfileBadge();
  renderProfileMenu();
  haptic('success');
}

function deleteProfileById(id){
  const profiles = loadProfiles();
  if (profiles.length <= 1){
    alert(lang==='ar' ? 'Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ø¢Ø®Ø± Ø¨Ø±ÙˆÙØ§ÙŠÙ„.' : "You can't delete the last profile.");
    haptic('error');
    return;
  }

  const p = profiles.find(x=>x.id===id);
  const ok = confirm(
    (lang==='ar' ? `Ø­Ø°Ù Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ "${p?.name||''}"ØŸ` : `Delete profile "${p?.name||''}"?`) +
    (lang==='ar' ? '\nØ³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© ÙˆØ§Ù„Ø³Ø¬Ù„.' : '\nThis removes its budget and history.')
  );
  if (!ok) return;

  // if deleting active profile, switch to another
  const active = getActiveProfileId();

  // delete storage
  localStorage.removeItem(profileStoreKey(id));

  const remaining = profiles.filter(x=>x.id!==id);
  saveProfiles(remaining);

  if (id === active){
    persistCurrentProfile();
    setActiveProfileId(remaining[0].id);
    loadActiveProfileIntoApp();

    clearInput();
    updateBudget();
    renderHistory();
    applyFeatureVisibility();
    syncDecimalButton();
    renderAmountInput();
    applyLanguage();
    renderQuickBar();
    renderQuickEditor();
    renderProfileBadge();
  }

  renderProfileMenu();
  haptic('success');
}

/* ======= Currency helpers ======= */
function getCurrency(){
  return localStorage.getItem('currency') || 'USD';
}
function formatMoney(value){
  const currency = getCurrency();
  try{
    return new Intl.NumberFormat(undefined, { style:'currency', currency }).format(value);
  } catch(e){
    return `$${Number(value || 0).toFixed(2)}`;
  }
}

/* ======= Clock ======= */
function tickClock(){
  const n = new Date();
  document.getElementById('clock').textContent =
    'ğŸ•’ ' + n.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
}
setInterval(tickClock,1000); tickClock();

/* ======= INPUT STATE ======= */
let amountDigits = '';
let amountRaw = '';

function moneyFromDigits(d){
  if (!d) return 0;
  const cents = parseInt(d, 10);
  if (isNaN(cents)) return 0;
  return cents / 100;
}
function moneyFromRaw(s){
  if (!s) return 0;
  const v = parseFloat(s);
  if (isNaN(v)) return 0;
  return v;
}
function renderAmountInput(){
  const v = centsMode ? moneyFromDigits(amountDigits) : moneyFromRaw(amountRaw);
  inputEl.value = formatMoney(v);
}
function syncDecimalButton(){
  decimalBtn.style.display = centsMode ? 'none' : '';
}
function clearInput(){
  amountDigits = '';
  amountRaw = '';
  renderAmountInput();
}
function appendNumber(n){
  if (!/^\d$/.test(n)) return;

  if (centsMode){
    if (amountDigits.length >= 12) return;
    if (amountDigits === '0') amountDigits = '';
    amountDigits += n;
  } else {
    if (amountRaw.length >= 14) return;
    if (amountRaw.includes('.')){
      const parts = amountRaw.split('.');
      const dec = parts[1] ?? '';
      if (dec.length >= 2) return;
    }
    amountRaw += n;
  }
  renderAmountInput();
}
function appendDecimal(){
  if (centsMode) return;
  if (!amountRaw) amountRaw = '0';
  if (amountRaw.includes('.')) return;
  amountRaw += '.';
  renderAmountInput();
}
function backspace(){
  if (centsMode) amountDigits = amountDigits.slice(0, -1);
  else amountRaw = amountRaw.slice(0, -1);
  renderAmountInput();
}

/* âœ… Long-press backspace = clear */
(function initBackspaceLongPress(){
  if (!backspaceBtn) return;
  let t=null;
  const start=()=>{
    t=setTimeout(()=>{
      clearInput();
      haptic('success');
    }, 420);
  };
  const end=()=>{
    if (t){ clearTimeout(t); t=null; }
  };
  backspaceBtn.addEventListener('touchstart', start, {passive:true});
  backspaceBtn.addEventListener('touchend', end, {passive:true});
  backspaceBtn.addEventListener('mousedown', start);
  backspaceBtn.addEventListener('mouseup', end);
  backspaceBtn.addEventListener('mouseleave', end);
})();

/* âœ… Hold zero = add "00" */
(function initZeroHold(){
  if (!zeroBtn) return;
  let t=null;
  const start=()=>{
    t=setTimeout(()=>{
      appendNumber('0');
      appendNumber('0');
      haptic('success');
    }, 420);
  };
  const end=()=>{
    if (t){ clearTimeout(t); t=null; }
  };
  zeroBtn.addEventListener('touchstart', start, {passive:true});
  zeroBtn.addEventListener('touchend', end, {passive:true});
  zeroBtn.addEventListener('mousedown', start);
  zeroBtn.addEventListener('mouseup', end);
  zeroBtn.addEventListener('mouseleave', end);
})();

/* âœ… QUICK AMOUNTS BAR (adjustable per profile) */
function renderQuickBar(){
  const bar = document.getElementById('quickBar');
  if (!bar) return;

  const addLabel = (lang==='ar') ? 'â• Ø¥Ø¶Ø§ÙØ©' : 'â• Add';
  bar.innerHTML = `
    <button class="quick-btn" onclick="quickApplyFixed(+1)">${addLabel}</button>
    ${quickAmounts.map(a=>{
      const sign = a < 0 ? 'âˆ’' : '+';
      const label = `${sign}${Math.abs(a)}`;
      return `<button class="quick-btn" onclick="quickApplyFixed(${a})">${label}</button>`;
    }).join('')}
  `;
}

/* fixed apply:
   +N => Add N
   -N => Subtract N (Quick)
*/
function quickApplyFixed(delta){
  const v = Math.abs(Number(delta || 0));
  if (!v) return;

  const ts = new Date().toLocaleString();
  if (delta < 0){
    budget -= v;
    history.push({type:'Subtract (Quick)', value:v, timestamp:ts});
  } else {
    budget += v;
    history.push({type:'Add (Quick)', value:v, timestamp:ts});
  }
  saveBudget();
  renderHistory();
  clearInput();
  haptic('success');
}

/* Quick editor inside settings */
function renderQuickEditor(){
  const holder = document.getElementById('quickEditor');
  if (!holder) return;

  holder.innerHTML = quickAmounts.map((a,i)=>`
    <div class="quick-row">
      <span>${a < 0 ? 'âˆ’' : '+'}${Math.abs(a)}</span>
      <div class="quick-row-actions">
        <button class="mini-btn" onclick="editQuickAmount(${i})">âœï¸</button>
        <button class="mini-btn danger" onclick="removeQuickAmount(${i})">ğŸ—‘</button>
      </div>
    </div>
  `).join('');
}
function addQuickAmount(){
  const inp = document.getElementById('quickNew');
  const n = Number(inp.value);
  if (!n || !isFinite(n)) return;

  // default to negative because your set was -1 -3 -5 -10 -20
  const val = -Math.abs(n);

  if (quickAmounts.includes(val)) { inp.value=''; return; }
  quickAmounts.push(val);

  inp.value='';
  persistCurrentProfile();
  renderQuickEditor();
  renderQuickBar();
  haptic('success');
}
function removeQuickAmount(i){
  quickAmounts.splice(i,1);
  persistCurrentProfile();
  renderQuickEditor();
  renderQuickBar();
  haptic('success');
}
function editQuickAmount(i){
  const current = quickAmounts[i];
  const raw = prompt(lang==='ar' ? 'Ø§ÙƒØªØ¨ Ø§Ù„Ø±Ù‚Ù… (Ù…Ø«Ø§Ù„: -5 Ø£Ùˆ 5)' : 'Enter number (ex: -5 or 5)', String(current));
  if (raw === null) return;

  const n = Number(raw);
  if (!n || !isFinite(n)) return;

  quickAmounts[i] = n; // allow + or -
  persistCurrentProfile();
  renderQuickEditor();
  renderQuickBar();
  haptic('success');
}

/* ======= Add/Subtract (typed) ======= */
function getCurrentAmount(){
  return centsMode ? moneyFromDigits(amountDigits) : moneyFromRaw(amountRaw);
}
function submitAmount(type){
  const v = getCurrentAmount();
  if (!v) return;

  const ts = new Date().toLocaleString();
  if (type==='add'){
    budget += v;
    history.push({id: uid(), kind:'add', type:'Add', value:v, timestamp:ts});
  }
  saveBudget();
  renderHistory();
  clearInput();
}

/* ======= Helpers for modals ======= */
function showOverlay(){ overlay.style.display='block'; }
function hideOverlay(){
  if (settingsModal.style.display !== 'block' &&
      profileMenu.style.display !== 'block' &&
      document.querySelectorAll('.sleek-modal').length === 0){
    overlay.style.display='none';
  }
}
function closeTempModals(){
  document.querySelectorAll('.sleek-modal').forEach(el=>el.remove());
  hideOverlay();
}

/* ======= Save/update budget ======= */
function saveBudget(){
  updateBudget();
  persistCurrentProfile();
}
function updateBudget(){
  document.getElementById('budget').textContent = `Budget: ${formatMoney(budget)}`;
}
function renderHistory(){
  historyEl.innerHTML = '';
  history.slice().reverse().forEach((it, idx)=>{
    const d=document.createElement('div');
    d.className = 'history-item';
    d.textContent = `${it.timestamp} â€” ${it.type || it.kind || ''}: ${formatMoney(it.value)}`;
    d.onclick = ()=> openEditHistory(idx);
    historyEl.appendChild(d);
  });
}
<!-- =========================
PART 1.3 / 3
EDIT HISTORY ENTRIES (CHANGE AMOUNT / TYPE / CATEGORY)
Ask for â€œ2.3â€ when ready.
========================= -->
/* =========================
   EDIT HISTORY SYSTEM
   ========================= */

/*
History item structure used:
{
  id,
  kind: 'add' | 'subtract',
  category?: string,
  value: number,
  timestamp: string
}
*/

/* Open edit modal when clicking a history item */
function openEditHistory(index){
  const item = history.slice().reverse()[index];
  if (!item) return;

  // real index in original history array
  const realIndex = history.length - 1 - index;

  const modal = document.createElement('div');
  modal.className = 'modal sleek-modal';

  const isSubtract = item.kind === 'subtract';

  modal.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <h3>${lang==='ar'?'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©':'Edit Entry'}</h3>
      <button class="close-btn" onclick="closeTempModals()">âœ–</button>
    </div>

    <label style="margin-top:10px;font-weight:800;">
      ${lang==='ar'?'Ø§Ù„Ù…Ø¨Ù„Øº':'Amount'}
      <input id="editAmount" type="number" inputmode="decimal" value="${item.value}" />
    </label>

    <label style="margin-top:10px;font-weight:800;">
      ${lang==='ar'?'Ø§Ù„Ù†ÙˆØ¹':'Type'}
      <select id="editKind">
        <option value="add" ${item.kind==='add'?'selected':''}>${lang==='ar'?'Ø¥Ø¶Ø§ÙØ©':'Add'}</option>
        <option value="subtract" ${item.kind==='subtract'?'selected':''}>${lang==='ar'?'Ø®ØµÙ…':'Subtract'}</option>
      </select>
    </label>

    <div id="editCategoryWrap" style="margin-top:10px;${isSubtract?'':'display:none'}">
      <label style="font-weight:800;">
        ${lang==='ar'?'Ø§Ù„ÙØ¦Ø©':'Category'}
        <select id="editCategory">
          ${categories.map(c=>`
            <option value="${escapeHtml(c)}" ${c===item.category?'selected':''}>
              ${escapeHtml(c)}
            </option>
          `).join('')}
        </select>
      </label>
    </div>

    <button class="btn" style="margin-top:16px;" onclick="saveEditedHistory(${realIndex})">
      ${lang==='ar'?'Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„':'Save Changes'}
    </button>
  `;

  document.body.appendChild(modal);
  overlay.style.display='block';

  // toggle category selector when type changes
  modal.querySelector('#editKind').onchange = (e)=>{
    const wrap = modal.querySelector('#editCategoryWrap');
    wrap.style.display = e.target.value === 'subtract' ? '' : 'none';
  };
}

/* Save edited history entry */
function saveEditedHistory(realIndex){
  const oldItem = history[realIndex];
  if (!oldItem) return;

  const amount = Number(document.getElementById('editAmount').value);
  const kind = document.getElementById('editKind').value;
  const catSel = document.getElementById('editCategory');

  if (!amount || amount <= 0) return;

  /* 1ï¸âƒ£ Reverse old entry */
  if (oldItem.kind === 'add'){
    budget -= oldItem.value;
  } else {
    budget += oldItem.value;
  }

  /* 2ï¸âƒ£ Apply new entry */
  const newItem = {
    id: oldItem.id,
    kind,
    value: amount,
    timestamp: oldItem.timestamp
  };

  if (kind === 'add'){
    budget += amount;
    newItem.type = 'Add';
  } else {
    const cat = catSel ? catSel.value : categories[0];
    budget -= amount;
    newItem.type = `Subtract (${cat})`;
    newItem.category = cat;
  }

  history[realIndex] = newItem;

  saveBudget();
  renderHistory();
  closeTempModals();
  haptic('success');
}

/* =========================
   IMPORTANT NOTES
   =========================
âœ” Budget is always recalculated correctly
âœ” You can change amount, type, and category
âœ” Category only shows for subtract
âœ” No data corruption
âœ” Works with profiles
*/
<!-- =========================
PART 2.3 / 3
HISTORY SEARCH + FILTER (DATE RANGE / CATEGORY / ADD VS SUBTRACT)
Ask for â€œ3.3â€ when ready.
========================= -->
/* =========================
   FILTER / SEARCH HISTORY
   ========================= */

/*
We keep the real history array unchanged.
Filters only change what is displayed.

Filters supported:
- Ensure: Add only / Subtract only / All
- Category (only applies to subtract entries)
- Date range (from / to)
*/

let historyFilters = {
  mode: 'all',        // 'all' | 'add' | 'subtract'
  category: 'all',    // 'all' or category name
  from: '',           // YYYY-MM-DD
  to: ''              // YYYY-MM-DD
};

let filtersOpen = false;

function openFilters(){
  // close other floating things
  closeProfileMenu();
  closeCharts();
  closePinModals();
  closeTempModals();

  const m = document.createElement('div');
  m.className = 'modal sleek-modal';
  m.id = 'filtersModal';

  const title = (lang==='ar') ? 'ÙÙ„ØªØ±Ø© Ø§Ù„Ø³Ø¬Ù„' : 'Filter History';
  const modeLbl = (lang==='ar') ? 'Ø§Ù„Ù†ÙˆØ¹' : 'Type';
  const catLbl  = (lang==='ar') ? 'Ø§Ù„ÙØ¦Ø©' : 'Category';
  const fromLbl = (lang==='ar') ? 'Ù…Ù† ØªØ§Ø±ÙŠØ®' : 'From';
  const toLbl   = (lang==='ar') ? 'Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®' : 'To';
  const applyLbl = (lang==='ar') ? 'ØªØ·Ø¨ÙŠÙ‚' : 'Apply';
  const clearLbl = (lang==='ar') ? 'Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ±' : 'Clear Filters';

  m.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center;width:100%;">
      <h3>${title}</h3>
      <button class="close-btn" onclick="closeFilters()">âœ–</button>
    </div>

    <div style="margin-top:12px;width:100%;">
      <label style="font-weight:900;display:block;margin-bottom:6px;">${modeLbl}</label>
      <select id="filterMode" class="mb-select">
        <option value="all">${lang==='ar'?'Ø§Ù„ÙƒÙ„':'All'}</option>
        <option value="add">${lang==='ar'?'Ø¥Ø¶Ø§ÙØ© ÙÙ‚Ø·':'Add only'}</option>
        <option value="subtract">${lang==='ar'?'Ø®ØµÙ… ÙÙ‚Ø·':'Subtract only'}</option>
      </select>

      <label style="font-weight:900;display:block;margin:10px 0 6px;">${catLbl}</label>
      <select id="filterCategory" class="mb-select">
        <option value="all">${lang==='ar'?'ÙƒÙ„ Ø§Ù„ÙØ¦Ø§Øª':'All categories'}</option>
        ${categories.map(c=>`<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('')}
      </select>

      <div style="display:flex;gap:10px;margin-top:10px;">
        <div style="flex:1;">
          <label style="font-weight:900;display:block;margin-bottom:6px;">${fromLbl}</label>
          <input id="filterFrom" type="date" class="mb-select" style="margin:0;" />
        </div>
        <div style="flex:1;">
          <label style="font-weight:900;display:block;margin-bottom:6px;">${toLbl}</label>
          <input id="filterTo" type="date" class="mb-select" style="margin:0;" />
        </div>
      </div>

      <button class="btn" style="margin-top:14px;" onclick="applyFilters()">${applyLbl}</button>
      <button class="btn danger" style="margin-top:10px;" onclick="clearFilters()">${clearLbl}</button>
    </div>
  `;

  document.body.appendChild(m);
  overlay.style.display = 'block';
  filtersOpen = true;

  // preload saved filters into inputs
  document.getElementById('filterMode').value = historyFilters.mode;
  document.getElementById('filterCategory').value = historyFilters.category;
  document.getElementById('filterFrom').value = historyFilters.from || '';
  document.getElementById('filterTo').value = historyFilters.to || '';
}

function closeFilters(){
  const el = document.getElementById('filtersModal');
  if (el) el.remove();
  filtersOpen = false;
  hideOverlay();
}

function applyFilters(){
  historyFilters.mode = document.getElementById('filterMode').value;
  historyFilters.category = document.getElementById('filterCategory').value;
  historyFilters.from = document.getElementById('filterFrom').value || '';
  historyFilters.to = document.getElementById('filterTo').value || '';

  // persist per-profile so each profile can have its own filters
  persistCurrentProfile();
  renderHistory();
  closeFilters();
  haptic('success');
}

function clearFilters(){
  historyFilters = { mode:'all', category:'all', from:'', to:'' };
  persistCurrentProfile();
  renderHistory();
  closeFilters();
  haptic('success');
}

/* helper: timestamp -> YYYY-MM-DD (works with your toLocaleString timestamps) */
function toYMD(ts){
  const d = new Date(ts);
  if (isNaN(d.getTime())) return '';
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,'0');
  const da = String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${da}`;
}

/* override renderHistory to support filters (keeps click-to-edit) */
const _renderHistoryOriginal = renderHistory;
renderHistory = function(){
  historyEl.innerHTML = '';

  // Build display list newest-first
  const list = history.slice().reverse();

  const from = historyFilters.from || '';
  const to = historyFilters.to || '';

  const filtered = list.filter(it=>{
    // normalize kind/type
    const kind = it.kind || (String(it.type||'').toLowerCase().startsWith('add') ? 'add' : 'subtract');

    // filter mode
    if (historyFilters.mode === 'add' && kind !== 'add') return false;
    if (historyFilters.mode === 'subtract' && kind !== 'subtract') return false;

    // filter category (only for subtract)
    if (historyFilters.category !== 'all'){
      if (kind !== 'subtract') return false;
      const cat = it.category || (String(it.type||'').match(/^Subtract \((.+)\)$/)?.[1] || '');
      if (cat !== historyFilters.category) return false;
    }

    // filter date range
    if (from || to){
      const ymd = toYMD(it.timestamp);
      if (!ymd) return false;
      if (from && ymd < from) return false;
      if (to && ymd > to) return false;
    }

    return true;
  });

  // Show a tiny indicator if filters are active
  const isActive =
    historyFilters.mode !== 'all' ||
    historyFilters.category !== 'all' ||
    !!historyFilters.from ||
    !!historyFilters.to;

  if (isActive){
    const chip = document.createElement('div');
    chip.className = 'filter-chip';
    chip.textContent = (lang==='ar') ? 'Ø§Ù„ÙÙ„Ø§ØªØ± Ù…ÙØ¹Ù„Ø©' : 'Filters active';
    chip.onclick = openFilters;
    historyEl.appendChild(chip);
  }

  // render items (keep click-to-edit)
  filtered.forEach((it, idx)=>{
    const d = document.createElement('div');
    d.className = 'history-item';
    const label = it.type || (it.kind==='add' ? 'Add' : (it.category ? `Subtract (${it.category})` : 'Subtract'));
    d.textContent = `${it.timestamp} â€” ${label}: ${formatMoney(it.value)}`;

    // idx is index in filtered list, but edit needs index in full reversed list.
    // We can compute the original reversed index by finding the same id+timestamp+value.
    d.onclick = ()=>{
      const reverseIndex = list.findIndex(x =>
        (x.id && it.id && x.id === it.id) ||
        (x.timestamp===it.timestamp && x.value===it.value && x.type===it.type)
      );
      if (reverseIndex >= 0) openEditHistory(reverseIndex);
      else openEditHistory(idx);
    };

    historyEl.appendChild(d);
  });

  if (!filtered.length){
    const empty = document.createElement('div');
    empty.className = 'history-empty';
    empty.textContent = (lang==='ar') ? 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬' : 'No results';
    historyEl.appendChild(empty);
  }
};

/* load/save filters per profile (optional but nice) */
function loadFiltersForProfile(){
  // stored inside profile data under "historyFilters" if present
  const id = getActiveProfileId();
  if (!id) return;
  const data = readProfileData(id);
  if (data.historyFilters){
    historyFilters = { ...historyFilters, ...data.historyFilters };
  }
}

/* patch persistCurrentProfile to include filters without breaking your existing one */
const _persistCurrentProfileOriginal = persistCurrentProfile;
persistCurrentProfile = function(){
  const id = getActiveProfileId();
  if (!id) return;
  writeProfileData(id, {
    budget,
    history,
    categories,
    featureSettings,
    centsMode,
    currency: getCurrency(),
    lang,
    quickAmounts,
    pinEnabled,
    pinHash,
    historyFilters // âœ… saved per profile
  });
};
<!-- =========================
PART 3.3 / 3
PIN LOCK (4-digit, no Face ID) + CHARTS (category + time)
This is the FINAL chunk for Part 3.
========================= -->
/* =========================
   PIN LOCK (4-DIGIT)
   ========================= */

/*
Stored per profile:
pinEnabled: boolean
pinHash: string  (SHA-256 hex)
*/

let pinModalOpen = false;

function closePinModals(){
  document.querySelectorAll('.pin-modal').forEach(el=>el.remove());
  pinModalOpen = false;
  hideOverlay();
}

/* WebCrypto SHA-256 hash (hex) */
async function sha256Hex(text){
  const enc = new TextEncoder().encode(text);
  const hashBuf = await crypto.subtle.digest('SHA-256', enc);
  const hashArr = Array.from(new Uint8Array(hashBuf));
  return hashArr.map(b=>b.toString(16).padStart(2,'0')).join('');
}

/* PIN settings entry point from Settings */
function openPinSettings(){
  closeProfileMenu();
  closeCharts();
  closeFilters();
  closeTempModals();

  const m = document.createElement('div');
  m.className = 'modal sleek-modal pin-modal';

  const title = (lang==='ar') ? 'Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª PIN' : 'PIN Settings';
  const status = pinEnabled ? (lang==='ar' ? 'Ù…ÙØ¹Ù‘Ù„' : 'Enabled') : (lang==='ar' ? 'ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„' : 'Disabled');

  m.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center;width:100%;">
      <h3>${title}</h3>
      <button class="close-btn" onclick="closePinModals()">âœ–</button>
    </div>

    <div style="margin-top:10px;font-weight:900;">
      ${lang==='ar'?'Ø§Ù„Ø­Ø§Ù„Ø©':'Status'}: <span style="opacity:.9">${status}</span>
    </div>

    <div style="margin-top:14px;display:flex;gap:10px;flex-wrap:wrap;">
      <button class="btn" style="flex:1" onclick="${pinEnabled ? 'openChangePinFlow()' : 'openSetPinFlow()'}">
        ${pinEnabled ? (lang==='ar'?'ØªØºÙŠÙŠØ± PIN':'Change PIN') : (lang==='ar'?'ØªØ¹ÙŠÙŠÙ† PIN':'Set PIN')}
      </button>

      ${pinEnabled ? `
        <button class="btn danger" style="flex:1" onclick="disablePinFlow()">
          ${lang==='ar'?'Ø¥ÙŠÙ‚Ø§Ù PIN':'Disable PIN'}
        </button>
      ` : ''}
    </div>
  `;

  document.body.appendChild(m);
  showOverlay();
  pinModalOpen = true;
}

/* PIN entry UI (reusable) */
function buildPinEntryModal(opts){
  // opts: { title, subtitle, onDone(pin), allowClose }
  const m = document.createElement('div');
  m.className = 'modal sleek-modal pin-modal';

  m.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center;width:100%;">
      <h3>${opts.title || 'PIN'}</h3>
      ${opts.allowClose ? `<button class="close-btn" onclick="closePinModals()">âœ–</button>` : `<div style="width:34px;height:34px;"></div>`}
    </div>

    ${opts.subtitle ? `<div style="text-align:center;margin-top:6px;font-weight:800;opacity:.92">${opts.subtitle}</div>` : ''}

    <div class="pin-dots" id="pinDots" style="margin-top:14px;">
      <span class="pin-dot"></span><span class="pin-dot"></span><span class="pin-dot"></span><span class="pin-dot"></span>
    </div>

    <div id="pinError" class="pin-error" style="display:none;margin-top:10px;text-align:center;font-weight:900;">
      ${lang==='ar'?'PIN ØºÙŠØ± ØµØ­ÙŠØ­':'Wrong PIN'}
    </div>

    <div class="pin-pad" style="margin-top:14px;">
      ${['1','2','3','4','5','6','7','8','9','0'].map(n=>`<button class="pin-key" data-pin="${n}">${n}</button>`).join('')}
      <button class="pin-key pin-back" data-pin="back">âŒ«</button>
      <button class="pin-key pin-clear" data-pin="clear">${lang==='ar'?'Ù…Ø³Ø­':'Clear'}</button>
    </div>
  `;

  let pin = '';

  function updateDots(){
    const dots = m.querySelectorAll('.pin-dot');
    dots.forEach((d,i)=> d.classList.toggle('filled', i < pin.length));
  }
  function showErr(){
    const e = m.querySelector('#pinError');
    e.style.display = 'block';
    m.classList.add('pin-shake');
    haptic('error');
    setTimeout(()=> m.classList.remove('pin-shake'), 220);
  }
  function hideErr(){
    const e = m.querySelector('#pinError');
    e.style.display = 'none';
  }

  m.addEventListener('click', async (ev)=>{
    const key = ev.target.closest('.pin-key');
    if (!key) return;

    const val = key.getAttribute('data-pin');
    hideErr();

    if (val === 'back'){
      pin = pin.slice(0,-1);
      updateDots();
      return;
    }
    if (val === 'clear'){
      pin = '';
      updateDots();
      return;
    }
    if (!/^\d$/.test(val)) return;

    if (pin.length >= 4) return;
    pin += val;
    updateDots();

    if (pin.length === 4){
      try{
        await opts.onDone(pin, { showErr, reset:()=>{ pin=''; updateDots(); } });
      }catch(e){
        showErr();
        pin = '';
        updateDots();
      }
    }
  });

  return m;
}

/* Set PIN flow */
function openSetPinFlow(){
  closePinModals();

  const title = (lang==='ar') ? 'ØªØ¹ÙŠÙŠÙ† PIN' : 'Set PIN';
  const sub1 = (lang==='ar') ? 'Ø£Ø¯Ø®Ù„ PIN Ù…Ù† 4 Ø£Ø±Ù‚Ø§Ù…' : 'Enter a 4-digit PIN';

  const step1 = buildPinEntryModal({
    title,
    subtitle: sub1,
    allowClose: true,
    onDone: async (pin1, helpers)=>{
      // go to confirm
      closePinModals();
      openConfirmPinFlow(pin1);
      haptic('success');
    }
  });

  document.body.appendChild(step1);
  showOverlay();
  pinModalOpen = true;
}

function openConfirmPinFlow(pin1){
  const title = (lang==='ar') ? 'ØªØ£ÙƒÙŠØ¯ PIN' : 'Confirm PIN';
  const sub2 = (lang==='ar') ? 'Ø£Ø¹Ø¯ Ø¥Ø¯Ø®Ø§Ù„ Ù†ÙØ³ PIN' : 'Re-enter the same PIN';

  const step2 = buildPinEntryModal({
    title,
    subtitle: sub2,
    allowClose: true,
    onDone: async (pin2, helpers)=>{
      if (pin2 !== pin1){
        helpers.showErr();
        helpers.reset();
        return;
      }
      pinEnabled = true;
      pinHash = await sha256Hex(pin2);
      persistCurrentProfile();
      closePinModals();
      haptic('success');
      alert(lang==='ar' ? 'ØªÙ… ØªÙØ¹ÙŠÙ„ PIN âœ…' : 'PIN enabled âœ…');
    }
  });

  document.body.appendChild(step2);
  showOverlay();
  pinModalOpen = true;
}

/* Change PIN flow (verify old -> set new) */
function openChangePinFlow(){
  closePinModals();

  const title = (lang==='ar') ? 'ØªØºÙŠÙŠØ± PIN' : 'Change PIN';
  const sub = (lang==='ar') ? 'Ø£Ø¯Ø®Ù„ PIN Ø§Ù„Ø­Ø§Ù„ÙŠ' : 'Enter current PIN';

  const verify = buildPinEntryModal({
    title,
    subtitle: sub,
    allowClose: true,
    onDone: async (pin, helpers)=>{
      const h = await sha256Hex(pin);
      if (h !== pinHash){
        helpers.showErr();
        helpers.reset();
        return;
      }
      // verified -> set new
      closePinModals();
      openSetPinFlow();
      haptic('success');
    }
  });

  document.body.appendChild(verify);
  showOverlay();
  pinModalOpen = true;
}

/* Disable PIN flow (verify old, then disable) */
function disablePinFlow(){
  closePinModals();

  const title = (lang==='ar') ? 'Ø¥ÙŠÙ‚Ø§Ù PIN' : 'Disable PIN';
  const sub = (lang==='ar') ? 'Ø£Ø¯Ø®Ù„ PIN Ù„Ù„ØªØ£ÙƒÙŠØ¯' : 'Enter PIN to confirm';

  const verify = buildPinEntryModal({
    title,
    subtitle: sub,
    allowClose: true,
    onDone: async (pin, helpers)=>{
      const h = await sha256Hex(pin);
      if (h !== pinHash){
        helpers.showErr();
        helpers.reset();
        return;
      }
      pinEnabled = false;
      pinHash = '';
      persistCurrentProfile();
      closePinModals();
      haptic('success');
      alert(lang==='ar' ? 'ØªÙ… Ø¥ÙŠÙ‚Ø§Ù PIN âœ…' : 'PIN disabled âœ…');
    }
  });

  document.body.appendChild(verify);
  showOverlay();
  pinModalOpen = true;
}

/* Lock screen on app open if PIN enabled */
function openPinUnlockIfNeeded(){
  if (!pinEnabled || !pinHash) return;

  // prevent closing: user must unlock
  const title = (lang==='ar') ? 'Ø£Ø¯Ø®Ù„ PIN' : 'Enter PIN';
  const sub = (lang==='ar') ? 'Ù„ÙØªØ­ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚' : 'to unlock';

  const unlock = buildPinEntryModal({
    title,
    subtitle: sub,
    allowClose: false,
    onDone: async (pin, helpers)=>{
      const h = await sha256Hex(pin);
      if (h !== pinHash){
        helpers.showErr();
        helpers.reset();
        return;
      }
      closePinModals();
      haptic('success');
    }
  });

  document.body.appendChild(unlock);
  showOverlay();
  pinModalOpen = true;
}

/* =========================
   CHARTS (CANVAS)
   ========================= */

let chartsOpen = false;

function closeCharts(){
  const el = document.getElementById('chartsModal');
  if (el) el.remove();
  chartsOpen = false;
  hideOverlay();
}

function openCharts(){
  closeProfileMenu();
  closeFilters();
  closePinModals();
  closeTempModals();

  const m = document.createElement('div');
  m.className = 'modal sleek-modal';
  m.id = 'chartsModal';

  const title = (lang==='ar') ? 'Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©' : 'Charts';

  m.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center;width:100%;">
      <h3>${title}</h3>
      <button class="close-btn" onclick="closeCharts()">âœ–</button>
    </div>

    <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;">
      <button class="btn" style="flex:1" onclick="drawCategoryChart()">${lang==='ar'?'Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø©':'By Category'}</button>
      <button class="btn" style="flex:1" onclick="drawTimeChart()">${lang==='ar'?'Ø­Ø³Ø¨ Ø§Ù„ÙˆÙ‚Øª':'Over Time'}</button>
    </div>

    <div style="margin-top:12px;">
      <canvas id="chartCanvas" width="720" height="420" style="width:100%;height:auto;border-radius:14px;"></canvas>
    </div>

    <div id="chartHint" style="margin-top:10px;text-align:center;font-weight:800;opacity:.9;">
      ${lang==='ar'?'Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø±Ø³Ù… Ø¨Ø§Ù„Ø£Ø¹Ù„Ù‰':'Pick a chart above'}
    </div>
  `;

  document.body.appendChild(m);
  showOverlay();
  chartsOpen = true;

  // default: category chart
  setTimeout(drawCategoryChart, 0);
}

/* Helpers: detect kind/category robustly */
function getEntryKind(it){
  if (it.kind) return it.kind; // 'add'/'subtract'
  const t = String(it.type||'').toLowerCase();
  if (t.startsWith('add')) return 'add';
  return 'subtract';
}
function getEntryCategory(it){
  if (it.category) return it.category;
  const m = String(it.type||'').match(/^Subtract \((.+)\)$/);
  return m ? m[1] : 'Others';
}

/* Simple bar chart (no external libs) */
function drawBars(ctx, labels, values, opts={}){
  const W = ctx.canvas.width, H = ctx.canvas.height;
  ctx.clearRect(0,0,W,H);

  const padL = 70, padR = 18, padT = 28, padB = 68;
  const chartW = W - padL - padR;
  const chartH = H - padT - padB;

  // background grid
  ctx.globalAlpha = 0.14;
  for (let i=0;i<=5;i++){
    const y = padT + (chartH * i/5);
    ctx.beginPath();
    ctx.moveTo(padL, y);
    ctx.lineTo(W-padR, y);
    ctx.stroke();
  }
  ctx.globalAlpha = 1;

  const maxV = Math.max(1, ...values);
  const barCount = values.length;
  const gap = Math.max(8, Math.floor(chartW * 0.02));
  const barW = Math.max(18, Math.floor((chartW - gap*(barCount-1)) / barCount));

  // axis labels
  ctx.font = '16px system-ui';
  ctx.textAlign = 'left';
  ctx.fillText(opts.title || 'Chart', padL, 18);

  // y labels
  ctx.font = '12px system-ui';
  ctx.textAlign = 'right';
  for (let i=0;i<=5;i++){
    const v = maxV * (1 - i/5);
    const y = padT + (chartH * i/5);
    ctx.globalAlpha = 0.75;
    ctx.fillText(formatMoney(v), padL - 8, y + 4);
  }
  ctx.globalAlpha = 1;

  // bars + x labels
  for (let i=0;i<barCount;i++){
    const v = values[i];
    const h = (v/maxV) * chartH;
    const x = padL + i*(barW+gap);
    const y = padT + (chartH - h);

    ctx.globalAlpha = 0.95;
    ctx.fillRect(x, y, barW, h);

    // value label
    ctx.globalAlpha = 1;
    ctx.textAlign = 'center';
    ctx.font = '12px system-ui';
    ctx.fillText(formatMoney(v), x + barW/2, y - 6);

    // x label (trim)
    const label = String(labels[i]);
    const short = label.length > 10 ? label.slice(0,10)+'â€¦' : label;
    ctx.globalAlpha = 0.9;
    ctx.fillText(short, x + barW/2, H - 26);
  }
  ctx.globalAlpha = 1;
}

/* Category chart: total subtract by category */
function drawCategoryChart(){
  const canvas = document.getElementById('chartCanvas');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');

  const totals = {};
  categories.forEach(c=> totals[c]=0);

  history.forEach(it=>{
    const kind = getEntryKind(it);
    if (kind !== 'subtract') return;
    const cat = getEntryCategory(it);
    if (totals[cat] === undefined) totals[cat] = 0;
    totals[cat] += Number(it.value || 0);
  });

  const entries = Object.entries(totals)
    .filter(([,v])=>v>0)
    .sort((a,b)=>b[1]-a[1])
    .slice(0, 8);

  const labels = entries.map(e=>e[0]);
  const values = entries.map(e=>e[1]);

  // draw
  drawBars(ctx, labels.length?labels:[(lang==='ar'?'Ù„Ø§ Ø¨ÙŠØ§Ù†Ø§Øª':'No data')],
           values.length?values:[0],
           { title: (lang==='ar'?'Ø§Ù„Ø®ØµÙ… Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø©':'Subtract by Category') });

  const hint = document.getElementById('chartHint');
  if (hint){
    hint.textContent = labels.length
      ? (lang==='ar'?'Ø¹Ø±Ø¶ Ø£Ø¹Ù„Ù‰ Ø§Ù„ÙØ¦Ø§Øª':'Showing top categories')
      : (lang==='ar'?'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø®ØµÙ… Ø¨Ø¹Ø¯':'No subtract entries yet');
  }
}

/* Time chart: subtract totals by day (last 14 days shown) */
function drawTimeChart(){
  const canvas = document.getElementById('chartCanvas');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');

  // build day totals
  const dayTotals = {}; // ymd -> amount
  history.forEach(it=>{
    const kind = getEntryKind(it);
    if (kind !== 'subtract') return;
    const ymd = toYMD(it.timestamp);
    if (!ymd) return;
    dayTotals[ymd] = (dayTotals[ymd] || 0) + Number(it.value || 0);
  });

  const days = Object.keys(dayTotals).sort();
  const last = days.slice(-14);
  const labels = last.map(d=>d.slice(5)); // MM-DD
  const values = last.map(d=>dayTotals[d]);

  drawBars(ctx, labels.length?labels:[(lang==='ar'?'Ù„Ø§ Ø¨ÙŠØ§Ù†Ø§Øª':'No data')],
           values.length?values:[0],
           { title: (lang==='ar'?'Ø§Ù„Ø®ØµÙ… Ø¹Ø¨Ø± Ø§Ù„Ø£ÙŠØ§Ù…':'Subtract over days') });

  const hint = document.getElementById('chartHint');
  if (hint){
    hint.textContent = labels.length
      ? (lang==='ar'?'Ø¢Ø®Ø± 14 ÙŠÙˆÙ…':'Last 14 days')
      : (lang==='ar'?'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø®ØµÙ… Ø¨Ø¹Ø¯':'No subtract entries yet');
  }
}

/* =========================
   FINAL INIT PATCHES
   ========================= */

/* Ensure subtract entries created elsewhere get kind/category if missing */
function normalizeHistoryEntries(){
  history = history.map(it=>{
    const out = { ...it };
    if (!out.id) out.id = uid();

    if (!out.kind){
      const t = String(out.type||'').toLowerCase();
      out.kind = t.startsWith('add') ? 'add' : 'subtract';
    }
    if (out.kind === 'subtract' && !out.category){
      out.category = getEntryCategory(out);
    }
    if (!out.type){
      out.type = out.kind === 'add' ? 'Add' : (out.category ? `Subtract (${out.category})` : 'Subtract');
    }
    return out;
  });
  persistCurrentProfile();
}

/* Call these inside your init() in Part 4:
   - loadFiltersForProfile();
   - normalizeHistoryEntries();
   - renderQuickBar();
   - renderQuickEditor();
   - openPinUnlockIfNeeded();
*/
<!-- =========================
PART 1.4 / 3
SETTINGS + LANGUAGE + THEME + SUBTRACT + CATEGORY TOTALS
(plus safe close helpers used by overlay)
Ask for â€œ2.4â€ when ready.
========================= -->
/* =========================
   THEME
   ========================= */
function toggleMode(){
  const dark = document.body.classList.contains('dark-mode');
  document.body.classList.toggle('dark-mode', !dark);
  document.body.classList.toggle('light-mode', dark);
  localStorage.setItem('theme', dark ? 'light' : 'dark');
  modeBtn.textContent = dark ? 'ğŸŒ™' : 'â˜€ï¸';
}
(function initTheme(){
  if (localStorage.getItem('theme')==='dark'){
    document.body.classList.add('dark-mode'); modeBtn.textContent='â˜€ï¸';
  } else {
    document.body.classList.add('light-mode'); modeBtn.textContent='ğŸŒ™';
  }
})();

/* =========================
   SETTINGS MODAL
   ========================= */
function openSettings(){
  closeProfileMenu();
  closeCharts();
  closeFilters();
  closePinModals();
  closeTempModals();

  renderSettings();
  settingsModal.style.display='block';
  overlay.style.display='block';
}
function closeSettings(){
  settingsModal.style.display='none';
  persistCurrentProfile();
  hideOverlay();
}

/* Apply feature visibility */
function applyFeatureVisibility(){
  repeatBtn.style.display = featureSettings.repeat ? '' : 'none';
  clearBtn.style.display  = featureSettings.clear  ? '' : 'none';
  resetBtn.style.display  = featureSettings.reset  ? '' : 'none';
}

/* Render settings controls */
function renderSettings(){
  // Feature toggles
  const tRepeat = document.getElementById('toggleRepeat');
  const tClear  = document.getElementById('toggleClear');
  const tReset  = document.getElementById('toggleReset');

  tRepeat.checked = !!featureSettings.repeat;
  tClear.checked  = !!featureSettings.clear;
  tReset.checked  = !!featureSettings.reset;

  applyFeatureVisibility();

  tRepeat.onchange = ()=>{ featureSettings.repeat=tRepeat.checked; persistCurrentProfile(); applyFeatureVisibility(); };
  tClear.onchange  = ()=>{ featureSettings.clear=tClear.checked;   persistCurrentProfile(); applyFeatureVisibility(); };
  tReset.onchange  = ()=>{ featureSettings.reset=tReset.checked;   persistCurrentProfile(); applyFeatureVisibility(); };

  // Currency
  const curSel = document.getElementById('currencySelect');
  if (curSel){
    curSel.value = getCurrency();
    curSel.onchange = ()=>{
      localStorage.setItem('currency', curSel.value);
      persistCurrentProfile();
      updateBudget();
      renderHistory();
      renderAmountInput();
      renderQuickBar();
    };
  }

  // Cents mode toggle
  const centsToggle = document.getElementById('toggleCentsMode');
  if (centsToggle){
    centsToggle.checked = centsMode;
    centsToggle.onchange = ()=>{
      centsMode = centsToggle.checked;
      clearInput();
      syncDecimalButton();
      persistCurrentProfile();
    };
  }

  // Categories list
  const list=document.getElementById('categoryList');
  list.innerHTML='';
  categories.forEach((c,i)=>{
    const row=document.createElement('div');
    row.innerHTML = `${escapeHtml(c)}
      <button style="float:right;background:#ef4444;color:#fff;border:none;border-radius:8px;padding:2px 8px;font-weight:800"
        onclick="removeCategory(${i})">X</button>`;
    list.appendChild(row);
  });

  // Quick editor (adjustable)
  renderQuickEditor();
}

/* Category add/remove */
function addCategory(){
  const inp=document.getElementById('newCategoryInput');
  const val=(inp.value||'').trim();
  if(!val || categories.includes(val)) return;
  categories.push(val);
  inp.value='';
  persistCurrentProfile();
  renderSettings();
}
function removeCategory(i){
  categories.splice(i,1);
  persistCurrentProfile();
  renderSettings();
}

/* =========================
   LANGUAGE
   ========================= */
function toggleLanguage(){
  lang = (lang==='en') ? 'ar' : 'en';
  localStorage.setItem('lang', lang);
  persistCurrentProfile();
  applyLanguage();
  renderQuickBar();
  if (profileMenu.style.display==='block') renderProfileMenu();
}

function applyLanguage(){
  const en={
    title:'Money Budgeter', settingsTitle:'Settings', languageLabel:'Language:',
    featuresLabel:'Features:', categoryLabel:'Custom Categories:',
    toggleRepeatLbl:'Show Repeat', toggleClearLbl:'Show Clear History',
    toggleResetLbl:'Show Reset', langBtn:'Switch to Arabic ğŸ‡¸ğŸ‡¦',
    historyLabel:'History', currencyLabel:'Currency:', toggleCentsLbl:'Smart cents input',
    profilesTitle:'Profiles',
    quickLabel:'Quick Amounts:',
    pinLabel:'PIN Lock:'
  };
  const ar={
    title:'Ù…Ø¯ÙŠØ± Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©', settingsTitle:'Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª', languageLabel:'Ø§Ù„Ù„ØºØ©:',
    featuresLabel:'Ø§Ù„Ø®ØµØ§Ø¦Øµ:', categoryLabel:'Ø§Ù„ÙØ¦Ø§Øª Ø§Ù„Ù…Ø®ØµØµØ©:',
    toggleRepeatLbl:'Ø¹Ø±Ø¶ Ø§Ù„ØªÙƒØ±Ø§Ø±', toggleClearLbl:'Ø¹Ø±Ø¶ Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„',
    toggleResetLbl:'Ø¹Ø±Ø¶ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¶Ø¨Ø·', langBtn:'Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ© ğŸ‡¬ğŸ‡§',
    historyLabel:'Ø§Ù„Ø³Ø¬Ù„', currencyLabel:'Ø§Ù„Ø¹Ù…Ù„Ø©:', toggleCentsLbl:'Ø¥Ø¯Ø®Ø§Ù„ Ø°ÙƒÙŠ (Ø³Ù†ØªØ§Øª)',
    profilesTitle:'Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„Ø§Øª',
    quickLabel:'Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„Ø³Ø±ÙŠØ¹Ø©:',
    pinLabel:'Ù‚ÙÙ„ PIN:'
  };
  const t=(lang==='ar')?ar:en;

  document.getElementById('title').textContent=t.title;
  document.getElementById('settingsTitle').textContent=t.settingsTitle;
  document.getElementById('languageLabel').textContent=t.languageLabel;
  document.getElementById('featuresLabel').textContent=t.featuresLabel;
  document.getElementById('categoryLabel').textContent=t.categoryLabel;
  document.getElementById('toggleRepeatLbl').textContent=t.toggleRepeatLbl;
  document.getElementById('toggleClearLbl').textContent=t.toggleClearLbl;
  document.getElementById('toggleResetLbl').textContent=t.toggleResetLbl;
  document.getElementById('langBtn').textContent=t.langBtn;
  document.getElementById('historyLabel').textContent=t.historyLabel;
  document.getElementById('currencyLabel').textContent=t.currencyLabel;
  document.getElementById('toggleCentsLbl').textContent=t.toggleCentsLbl;
  document.getElementById('profilesTitle').textContent=t.profilesTitle;

  // optional labels if present
  const ql = document.getElementById('quickLabel'); if (ql) ql.textContent = t.quickLabel;
  const pl = document.getElementById('pinLabel'); if (pl) pl.textContent = t.pinLabel;

  document.body.setAttribute('dir', (lang==='ar')?'rtl':'ltr');
}

/* =========================
   SUBTRACT FLOW (CATEGORY PICK)
   ========================= */
function openSubtract(){
  const v = getCurrentAmount();
  if (!v) return;

  const m = document.createElement('div');
  m.className = 'modal sleek-modal';

  m.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center;width:100%;">
      <h3>${lang==='ar'?'Ø§Ø®ØªØ± Ø§Ù„ÙØ¦Ø©':'Select Category'}</h3>
      <button class="close-btn" onclick="closeTempModals()">âœ–</button>
    </div>

    <div style="display:flex;flex-direction:column;align-items:center;width:100%;margin-top:8px;">
      ${categories.map(c =>
        `<button class="btn" style="width:90%;margin:6px 0;" onclick="doSubtract('${c.replace(/'/g,"&#39;")}')">${escapeHtml(c)}</button>`
      ).join('')}
    </div>
  `;

  document.body.appendChild(m);
  overlay.style.display='block';
}

function doSubtract(cat){
  const v = getCurrentAmount();
  if (!v) { closeTempModals(); return; }

  const ts = new Date().toLocaleString();
  budget -= v;

  history.push({
    id: uid(),
    kind: 'subtract',
    category: cat,
    type: `Subtract (${cat})`,
    value: v,
    timestamp: ts
  });

  saveBudget();
  renderHistory();
  clearInput();
  closeTempModals();
  haptic('success');
}

/* =========================
   CATEGORY TOTALS MODAL
   ========================= */
function viewCategoryTotals(){
  const totals = Object.fromEntries(categories.map(c=>[c,0]));

  history.forEach(h=>{
    const kind = h.kind || (String(h.type||'').toLowerCase().startsWith('add') ? 'add' : 'subtract');
    if (kind !== 'subtract') return;
    const cat = h.category || (String(h.type||'').match(/^Subtract \((.+)\)$/)?.[1] || '');
    if (totals[cat] !== undefined) totals[cat] += Number(h.value || 0);
  });

  const title = (lang==='ar'?'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙØ¦Ø§Øª':'Category Totals');

  const m = document.createElement('div');
  m.className = 'modal sleek-modal';
  m.innerHTML = `
    <div style="display:flex;justify-content:space-between;align-items:center;width:100%;">
      <h3>${title}</h3>
      <button class="close-btn" onclick="closeTempModals()">âœ–</button>
    </div>

    <div style="display:flex;flex-direction:column;align-items:center;width:100%;margin-top:8px;">
      ${categories.map(c =>
        `<button class="btn" style="width:90%;margin:6px 0;" disabled>${escapeHtml(c)}: ${formatMoney(totals[c])}</button>`
      ).join('')}
    </div>
  `;

  document.body.appendChild(m);
  overlay.style.display='block';
}

/* =========================
   CLEAR / RESET
   ========================= */
function clearHistory(){
  history = [];
  saveBudget();
  renderHistory();
  haptic('success');
}
function resetBudget(){
  budget = 0;
  saveBudget();
  haptic('success');
}

/* =========================
   COMPAT CLOSERS (used by overlay click)
   ========================= */
function closeFilters(){
  const el = document.getElementById('filtersModal');
  if (el) el.remove();
  hideOverlay();
}
function closeCharts(){
  const el = document.getElementById('chartsModal');
  if (el) el.remove();
  hideOverlay();
}
<!-- =========================
PART 2.4 / 3
FULLSCREEN HISTORY + iOS ZOOM BLOCK + FINAL â€œGLUEâ€ HELPERS
Ask for â€œ3.4â€ when ready.
========================= -->
/* =========================
   FULLSCREEN HISTORY
   ========================= */
function openFullHistory(){
  closeProfileMenu();
  closeCharts();
  closeFilters();
  closePinModals();
  closeTempModals();

  const holder = document.createElement('div');
  holder.className = 'sleek-modal';

  const panel = document.createElement('div');

  panel.innerHTML =
    `<h3 style="text-align:center;margin-bottom:10px;">${lang==='ar'?'Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ÙƒØ§Ù…Ù„':'Full History'}</h3>` +
    history.slice().reverse().map(it =>
      `<div style="padding:8px 6px;border-bottom:1px solid rgba(255,255,255,.08);">
        ${escapeHtml(it.timestamp)} â€” ${escapeHtml(it.type || (it.kind==='add'?'Add':'Subtract'))}: ${formatMoney(it.value)}
      </div>`
    ).join('') +
    `<button class="btn" style="margin-top:10px;width:100%;" onclick="closeTempModals()">${lang==='ar'?'Ø¥ØºÙ„Ø§Ù‚':'Close'}</button>`;

  holder.appendChild(panel);
  document.body.appendChild(holder);
  overlay.style.display = 'block';
}
document.getElementById('toggleHistoryBtn').addEventListener('click', openFullHistory);

/* =========================
   iOS ZOOM / GESTURE BLOCK
   ========================= */
(function(){
  document.addEventListener('gesturestart', function (e) { e.preventDefault(); }, { passive: false });
  let lastTouch = 0;
  document.addEventListener('touchend', function (e) {
    const now = Date.now();
    if (now - lastTouch <= 300) { e.preventDefault(); }
    lastTouch = now;
  }, { passive: false });
  document.addEventListener('wheel', function (e) {
    if (e.ctrlKey) e.preventDefault();
  }, { passive: false });
})();

/* =========================
   OPTIONAL: KEEP FILTERS LOADED PER PROFILE
   (if Part 2.3 added historyFilters to profile data)
   ========================= */
function loadFiltersForProfile(){
  const id = getActiveProfileId();
  if (!id) return;
  const data = readProfileData(id);
  if (data.historyFilters){
    historyFilters = { ...historyFilters, ...data.historyFilters };
  }
}

/* =========================
   NORMALIZE HISTORY (safety)
   Ensures every entry has id/kind/category/type
   ========================= */
function normalizeHistoryEntries(){
  history = history.map(it=>{
    const out = { ...it };
    if (!out.id) out.id = uid();

    if (!out.kind){
      const t = String(out.type||'').toLowerCase();
      out.kind = t.startsWith('add') ? 'add' : 'subtract';
    }

    if (out.kind === 'subtract' && !out.category){
      const m = String(out.type||'').match(/^Subtract \((.+)\)$/);
      out.category = m ? m[1] : 'Others';
    }

    if (!out.type){
      out.type = out.kind === 'add' ? 'Add' : (out.category ? `Subtract (${out.category})` : 'Subtract');
    }
    return out;
  });

  persistCurrentProfile();
}

/* =========================
   SAFER OVERLAY HIDE
   ========================= */
function hideOverlay(){
  // overlay should remain if any modal is open
  const anyTemp = document.querySelectorAll('.sleek-modal').length > 0;
  const anyPin  = document.querySelectorAll('.pin-modal').length > 0;
  const settingsOpen = settingsModal.style.display === 'block';
  const profilesOpen = profileMenu.style.display === 'block';
  const filtersOpenNow = !!document.getElementById('filtersModal');
  const chartsOpenNow = !!document.getElementById('chartsModal');

  if (anyTemp || anyPin || settingsOpen || profilesOpen || filtersOpenNow || chartsOpenNow){
    overlay.style.display = 'block';
  } else {
    overlay.style.display = 'none';
  }
}

/* =========================
   Keep overlay on when showing custom modals
   ========================= */
function showOverlay(){
  overlay.style.display='block';
}
</script>
<!-- =========================
PART 3.4 / 3
FINAL INIT + PWA BRIDGE + CLOSE HTML
(put this AFTER Parts 1.4 and 2.4)
========================= -->
/* =========================
   STARTUP / INIT
   ========================= */
function init(){
  // 1) Create first profile + migrate old single-profile data if needed
  migrateOldDataIntoDefaultProfileIfNeeded();

  // 2) Load active profile into live state
  const profiles = loadProfiles();
  if (!getActiveProfileId() && profiles.length){
    setActiveProfileId(profiles[0].id);
  }
  loadActiveProfileIntoApp();

  // 3) Load per-profile filters (from Part 2.3)
  if (typeof loadFiltersForProfile === 'function') loadFiltersForProfile();

  // 4) Normalize older history entries
  if (typeof normalizeHistoryEntries === 'function') normalizeHistoryEntries();

  // 5) Apply UI state
  applyLanguage();
  renderProfileBadge();
  renderQuickBar();
  renderQuickEditor();

  updateBudget();
  applyFeatureVisibility();
  syncDecimalButton();
  renderAmountInput();
  renderHistory();

  // 6) Set theme icon properly
  modeBtn.textContent = document.body.classList.contains('dark-mode') ? 'â˜€ï¸' : 'ğŸŒ™';

  // 7) PIN unlock gate (from Part 3.3)
  if (typeof openPinUnlockIfNeeded === 'function') openPinUnlockIfNeeded();
}
init();

/* =========================
   Safety: keep overlay in sync when ESC pressed (desktop)
   ========================= */
document.addEventListener('keydown', (e)=>{
  if (e.key === 'Escape'){
    closeSettings();
    closeProfileMenu();
    closeTempModals();
    closeFilters();
    closeCharts();
    closePinModals();
    hideOverlay();
  }
});
</script>

<script src="/pwa-bridge.js"></script>

</body>
</html>
