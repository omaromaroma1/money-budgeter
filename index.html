<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Money Budgeter</title>

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="theme-color" content="#0a6bff" />

  <link rel="manifest" href="/manifest.json" />
  <link rel="apple-touch-icon" href="/icon-192.png" />

  <!-- CSS comes later -->
  <link rel="stylesheet" href="style.css" />
</head>

<body class="light-mode">

  <div class="calculator-box">

    <!-- Profile badge -->
    <div id="profile-badge" onclick="toggleProfileMenu()">ğŸ™‚</div>

    <!-- Settings -->
    <div id="settings-icon" onclick="openSettings()">âš™ï¸</div>

    <h1 id="title">Money Budgeter</h1>
    <div id="clock">ğŸ•’ --:--</div>
    <div id="budget">Budget: $0.00</div>

    <input id="input-display" readonly placeholder="0.00" />

    <!-- Quick amounts -->
    <div id="quickBar" class="quick-bar"></div>

    <!-- Numpad -->
    <div class="numpad">
      <button onclick="appendNumber('1')">1</button>
      <button onclick="appendNumber('2')">2</button>
      <button onclick="appendNumber('3')">3</button>
      <button onclick="appendNumber('4')">4</button>
      <button onclick="appendNumber('5')">5</button>
      <button onclick="appendNumber('6')">6</button>
      <button onclick="appendNumber('7')">7</button>
      <button onclick="appendNumber('8')">8</button>
      <button onclick="appendNumber('9')">9</button>
      <button id="zeroBtn" onclick="appendNumber('0')">0</button>
      <button id="decimalBtn" onclick="appendDecimal()">.</button>
      <button id="backspaceBtn" onclick="backspace()">âŒ«</button>
    </div>

    <!-- Main buttons -->
    <div class="buttons">
      <button onclick="submitAmount('add')">Add</button>
      <button onclick="openSubtract()">Subtract</button>
      <button onclick="clearHistory()">Clear History</button>
      <button onclick="resetBudget()">Reset</button>
      <button onclick="openCharts()">ğŸ“ˆ Charts</button>
      <button onclick="openFilters()">ğŸ” Filter</button>
    </div>

    <!-- History -->
    <div class="history-header">
      <div id="historyLabel">History</div>
      <button class="history-toggle" onclick="openFullHistory()">Expand â‡µ</button>
    </div>

    <div id="history"></div>
  </div>

  <!-- Theme toggle -->
  <div id="mode-toggle" onclick="toggleMode()">ğŸŒ™</div>

  <!-- Overlay -->
  <div id="overlay"></div>

  <!-- Profile menu -->
  <div id="profileMenu" class="profile-menu">
    <div class="profile-menu-head">
      <strong>Profiles</strong>
      <button class="close-btn" onclick="closeProfileMenu()">âœ–</button>
    </div>
    <div id="profileList"></div>
    <button class="btn" onclick="addProfile()">â• Add Profile</button>
  </div>

  <!-- Settings -->
  <div id="settingsModal" class="modal">
    <h3>Settings</h3>

    <label>
      Smart cents
      <input type="checkbox" id="toggleCentsMode" />
    </label>

    <button class="btn" onclick="openPinSettings()">ğŸ”’ PIN Settings</button>
    <button class="btn" onclick="closeSettings()">Close</button>
  </div>

<script>
/* =========================
   CORE STATE
========================= */
const overlay = document.getElementById('overlay');
const inputEl = document.getElementById('input-display');
const historyEl = document.getElementById('history');
const decimalBtn = document.getElementById('decimalBtn');
const backspaceBtn = document.getElementById('backspaceBtn');
const zeroBtn = document.getElementById('zeroBtn');
const profileBadge = document.getElementById('profile-badge');
const profileMenu = document.getElementById('profileMenu');
const profileList = document.getElementById('profileList');
const settingsModal = document.getElementById('settingsModal');

let amountDigits = '';
let amountRaw = '';
let centsMode = true;
let budget = 0;
let history = [];
let profiles = [];
let activeProfileId = null;

/* =========================
   SAFE OVERLAY
========================= */
function showOverlay(){
  overlay.classList.add('active');
}
function hideOverlay(){
  overlay.classList.remove('active');
}
overlay.onclick = () => {
  closeProfileMenu();
  closeSettings();
  hideOverlay();
};

/* =========================
   INPUT
========================= */
function moneyFromDigits(d){ return d ? parseInt(d,10)/100 : 0; }
function renderAmount(){
  const v = centsMode ? moneyFromDigits(amountDigits) : parseFloat(amountRaw||0);
  inputEl.value = v.toFixed(2);
}
function appendNumber(n){
  if(centsMode){
    amountDigits += n;
  }else{
    amountRaw += n;
  }
  renderAmount();
}
function appendDecimal(){
  if(centsMode) return;
  if(!amountRaw.includes('.')) amountRaw += '.';
  renderAmount();
}
function backspace(){
  if(centsMode) amountDigits = amountDigits.slice(0,-1);
  else amountRaw = amountRaw.slice(0,-1);
  renderAmount();
}

/* long press backspace = clear */
let backTimer;
backspaceBtn.onmousedown = () => backTimer = setTimeout(clearInput, 400);
backspaceBtn.onmouseup = () => clearTimeout(backTimer);
zeroBtn.onmousedown = () => backTimer = setTimeout(()=>{appendNumber('0');appendNumber('0')},400);
zeroBtn.onmouseup = () => clearTimeout(backTimer);

function clearInput(){
  amountDigits = '';
  amountRaw = '';
  renderAmount();
}

/* =========================
   BUDGET
========================= */
function submitAmount(type){
  const v = centsMode ? moneyFromDigits(amountDigits) : parseFloat(amountRaw||0);
  if(!v) return;
  if(type === 'add') budget += v;
  history.push({ type, value:v, ts:new Date().toLocaleString() });
  updateBudget();
  renderHistory();
  clearInput();
}
function updateBudget(){
  document.getElementById('budget').textContent = `Budget: $${budget.toFixed(2)}`;
}
function clearHistory(){
  history = [];
  renderHistory();
}
function resetBudget(){
  budget = 0;
  updateBudget();
}

/* =========================
   HISTORY
========================= */
function renderHistory(){
  historyEl.innerHTML = '';
  history.slice().reverse().forEach(h=>{
    const d = document.createElement('div');
    d.textContent = `${h.ts} â€” ${h.type}: $${h.value.toFixed(2)}`;
    historyEl.appendChild(d);
  });
}
function openFullHistory(){
  alert('Fullscreen history (CSS later)');
}

/* =========================
   PROFILES (MINIMAL)
========================= */
function toggleProfileMenu(){
  profileMenu.style.display = 'block';
  showOverlay();
}
function closeProfileMenu(){
  profileMenu.style.display = 'none';
}
function addProfile(){
  const name = prompt('Profile name?');
  const emoji = prompt('Emoji?', 'ğŸ™‚');
  if(!name) return;
  profiles.push({id:Date.now(), name, emoji});
  renderProfiles();
}
function renderProfiles(){
  profileList.innerHTML = '';
  profiles.forEach(p=>{
    const b = document.createElement('button');
    b.textContent = `${p.emoji} ${p.name}`;
    b.onclick = ()=>{
      activeProfileId = p.id;
      profileBadge.textContent = p.emoji;
      closeProfileMenu();
      hideOverlay();
    };
    profileList.appendChild(b);
  });
}

/* =========================
   SETTINGS
========================= */
function openSettings(){
  settingsModal.style.display = 'block';
  showOverlay();
}
function closeSettings(){
  settingsModal.style.display = 'none';
}

/* =========================
   THEME
========================= */
function toggleMode(){
  document.body.classList.toggle('dark-mode');
  document.body.classList.toggle('light-mode');
}

/* =========================
   CLOCK
========================= */
setInterval(()=>{
  document.getElementById('clock').textContent =
    'ğŸ•’ ' + new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
},1000);

/* =========================
   INIT
========================= */
updateBudget();
renderAmount();
renderProfiles();
</script>

<script src="/pwa-bridge.js"></script>
</body>
</html>
